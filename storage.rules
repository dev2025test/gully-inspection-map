rules_version = '2';

// Craft rules based on data in your Firestore database
service firebase.storage {
  match /b/{bucket}/o {
    // Allow authenticated users to read all files
    match /{allPaths=**} {
      allow read: if request.auth != null;
    }
    
    // Allow authenticated users to upload photos to inspections folder
    match /inspections/{gullyId}/{fileName} {
      allow write: if request.auth != null 
        && request.resource.size < 10 * 1024 * 1024  // 10MB max file size
        && request.resource.contentType.matches('image/.*')  // Only image files
        && fileName.matches('.*\\.(jpg|jpeg|png|gif|webp)$');  // Valid image extensions
    }
    
    // Allow authenticated users to upload photos to asset folders
    match /{assetType}/{gullyId}/{fileName} {
      allow write: if request.auth != null 
        && assetType in ['gullies', 'playgrounds', 'walkways', 'signage', 'lining']
        && request.resource.size < 10 * 1024 * 1024  // 10MB max file size
        && request.resource.contentType.matches('image/.*')  // Only image files
        && fileName.matches('.*\\.(jpg|jpeg|png|gif|webp)$');  // Valid image extensions
    }
    
    // Allow admins to delete files
    match /{allPaths=**} {
      allow delete: if request.auth != null 
        && exists(/databases/$(firebase.database.name)/documents/users/$(request.auth.uid))
        && get(/databases/$(firebase.database.name)/documents/users/$(request.auth.uid)).data.role in ['admin'];
    }
  }
}
