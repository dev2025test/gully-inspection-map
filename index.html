<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gully Inspection System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; display: none; }
    #loginScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3); text-align: center;
    }
    #controlPanel, #summary {
      position: absolute; background: white; padding: 10px;
      border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,0.3); z-index: 999;
    }
    #controlPanel { bottom: 10px; left: 10px; display: none; }
    #summary { top: 10px; right: 10px; font-size: 0.9em; display: none; }
    .dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #000; }
    .popup-form input, .popup-form select, .popup-form textarea { width: 100%; margin-bottom: 6px; }
    .inspection-popup .leaflet-popup-content {
      margin: 5px;
      width: auto !important;
    }
    .popup-form input[type="text"],
    .popup-form input[type="date"],
    .popup-form select,
    .popup-form textarea {
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .popup-form button {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .popup-form button:hover {
      background: #e0e0e0;
    }
    .popup-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .layer-control {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      margin-left: 10px;
      margin-top: 10px;
    }
    .layer-control select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .layer-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .layer-content.expanded {
      max-height: 500px;
    }
    .layer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 5px;
      background: #f5f5f5;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .layer-header:hover {
      background: #e0e0e0;
    }
    .collapse-icon {
      transition: transform 0.3s ease;
    }
    .collapse-icon.expanded {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
<div id="roleBanner" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);
background:#eee;padding:8px 20px;border-radius:6px;box-shadow:0 0 4px rgba(0,0,0,0.3);z-index:1001;
font-weight:bold;"></div>

<div id="loginScreen">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<div id="map"></div>

<div id="controlPanel">
  <label for="importFile" style="background:#ddd;padding:6px 12px;border-radius:4px;cursor:pointer;">üóÇÔ∏è Import</label>
  <input type="file" id="importFile" accept=".kml" style="display:none;">
  <span id="fileNameDisplay" style="margin-left:10px;font-style:italic;color:#555;"></span>
  
  <button onclick="exportData()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;margin-left:5px;">üíæ Export CSV</button>
  <button onclick="resetMap()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">‚ôªÔ∏è Reset</button>
  <button onclick="saveGullyData()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üíæ Backup JSON</button>
  <button onclick="enableDeleteMode()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üóëÔ∏è Delete Gully</button>
  <button onclick="enableEditMode()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">‚úèÔ∏è Edit Gully</button>
  <button onclick="logout()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;margin-left:5px;">üö™ Logout</button>
  
  <div style="margin-top:10px;display:flex;gap:5px;align-items:center;">
    <button onclick="toggleLayerPanel()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üó∫Ô∏è Layers</button>
    <select id="activeLayer" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;cursor:pointer;">
      <option value="gullies">üîµ Gullies</option>
      <option value="signage">üö∏ Signage</option>
      <option value="playgrounds">üéÆ Playgrounds</option>
      <option value="parks">üå≥ Parks</option>
      <option value="walkways">üö∂ Walkways</option>
      <option value="lining">üé® Lining</option>
    </select>
  </div>

  <div id="layerPanel" style="display:none;margin-top:5px;background:#f8f8f8;padding:8px;border-radius:4px;border:1px solid #ddd;">
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:5px;">
      <button class="layer-toggle" data-layer="gullies" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:blue;">‚¨§</span> Gullies
      </button>
      <button class="layer-toggle" data-layer="signage" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:orange;">‚¨§</span> Signage
      </button>
      <button class="layer-toggle" data-layer="playgrounds" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:green;">‚¨§</span> Playgrounds
      </button>
      <button class="layer-toggle" data-layer="parks" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:darkgreen;">‚¨§</span> Parks
      </button>
      <button class="layer-toggle" data-layer="walkways" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:purple;">‚¨§</span> Walkways
      </button>
      <button class="layer-toggle" data-layer="lining" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:red;">‚¨§</span> Lining
      </button>
    </div>
  </div>
</div>

<div id="summary">
  <b>Summary</b><br>
  <div id="summaryContent"></div>
  <label>Filter:</label>
  <select id="filterStatus" onchange="filterByStatus()">
    <option value="All">All</option>
    <option value="Clear">Clear</option>
    <option value="Broken">Broken</option>
    <option value="Remediation">Remediation</option>
    <option value="Replacement">Replacement</option>
    <option value="Blocked">Blocked</option>
    <option value="Expired">Expired</option>
  </select>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBsteq-tHQdiDcRk5UBg52AwAxpVcq67cw",
  authDomain: "gullytest3.firebaseapp.com",
  databaseURL: "https://gullytest3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gullytest3",
  storageBucket: "gullytest3.appspot.com",
  messagingSenderId: "876083677912",
  appId: "1:876083677912:web:065de0c7cca446b78f65ad"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// Define default users
const defaultUsers = [
  {
    email: 'ronan_oconnor@corkcity.ie',
    role: 'operator',
    name: "Ronan O'Connor",
    initials: 'RO'
  },
  {
    email: 'aman_kushwaha@corkcity.ie',
    role: 'admin',
    name: 'Aman Kushwaha',
    initials: 'AK'
  }
];

// Function to ensure default users exist
function ensureDefaultUsers() {
  defaultUsers.forEach(user => {
    const normalizedEmail = normalizeEmail(user.email);
    auth.fetchSignInMethodsForEmail(normalizedEmail)
      .then((signInMethods) => {
        if (signInMethods.length === 0) {
          // User doesn't exist, create them
          console.log('Creating user:', normalizedEmail);
          auth.createUserWithEmailAndPassword(normalizedEmail, 'DefaultPass123!')
            .then((userCredential) => {
              return db.ref("users/" + userCredential.user.uid).set({
                email: normalizedEmail,
                role: user.role,
                name: user.name,
                initials: user.initials,
                created: firebase.database.ServerValue.TIMESTAMP
              });
            })
            .catch(error => console.error('Error creating user:', error));
        }
      })
      .catch(error => console.error('Error checking user:', error));
  });
}

// Update the normalizeEmail function to be more robust
function normalizeEmail(email) {
  if (!email) return '';
  email = email.toLowerCase().trim();
  
  // Map all variations to standard format
  const emailMap = {
    'ronan.oconnor@corkcity.ie': 'ronan_oconnor@corkcity.ie',
    'ronan_oconnor@corkcity.ie': 'ronan_oconnor@corkcity.ie',
    'aman.kushwaha@corkcity.ie': 'aman_kushwaha@corkcity.ie',
    'aman_kushwaha@corkcity.ie': 'aman_kushwaha@corkcity.ie',
    'aman.kushawaha@corkcity.ie': 'aman_kushwaha@corkcity.ie',
    'aman_kushawaha@corkcity.ie': 'aman_kushwaha@corkcity.ie'
  };
  
  return emailMap[email] || email;
}

// Initialize the application
window.onload = () => {
  document.getElementById("loginScreen").style.display = "block";
  // Ensure default users exist
  ensureDefaultUsers();
};

let currentRole = null;
let map;
const importedFiles = new Set();
const gullyData = [];
let deleteMode = false;
let currentMarker = null;
let editMode = false;
let currentActiveLayer = 'gullies';
let currentInspectionPopup = null;
let inactivityTimer = null;
const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds

// Add layer groups
let layers = {
  gullies: L.layerGroup(),
  signage: L.layerGroup(),
  playgrounds: L.layerGroup(),
  parks: L.layerGroup(),
  walkways: L.layerGroup(),
  lining: L.layerGroup()
};

// Add layer names for UI
const layerNames = {
  gullies: "Gullies",
  signage: "Signage",
  playgrounds: "Playgrounds",
  parks: "Parks",
  walkways: "Walkways",
  lining: "Lining"
};

function resetInactivityTimer() {
  // Clear existing timer
  if (inactivityTimer) {
    clearTimeout(inactivityTimer);
  }
  
  // Set new timer
  inactivityTimer = setTimeout(() => {
    if (auth.currentUser) {
      alert('You have been logged out due to inactivity.');
      logout();
    }
  }, INACTIVITY_TIMEOUT);
}

function setupInactivityTracking() {
  // Track mouse movement
  document.addEventListener('mousemove', resetInactivityTimer);
  
  // Track clicks
  document.addEventListener('click', resetInactivityTimer);
  
  // Track keyboard activity
  document.addEventListener('keydown', resetInactivityTimer);
  
  // Track scroll events
  document.addEventListener('scroll', resetInactivityTimer);
  
  // Track map interactions
  map.on('drag', resetInactivityTimer);
  map.on('zoom', resetInactivityTimer);
  map.on('click', resetInactivityTimer);
  
  // Track form interactions
  document.addEventListener('input', resetInactivityTimer);
  
  // Start initial timer
  resetInactivityTimer();
}

// Update the login function to handle roles properly
function login() {
  const email = normalizeEmail(document.getElementById("email").value);
  const password = document.getElementById("password").value;
  
  if (!email || !password) {
    document.getElementById("loginError").textContent = "‚ùå Please enter both email and password";
    return;
  }

  document.getElementById("loginError").textContent = "Logging in...";
  
  // First try to sign in
  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      return db.ref("users/" + userCredential.user.uid).once("value");
    })
    .catch(error => {
      // If login fails and using default password, create account
      if (password === 'DefaultPass123!' && 
          (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password')) {
        return auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const isAman = email.toLowerCase().includes('aman');
            const userData = {
              email: email,
              role: isAman ? 'admin' : 'operator',
              name: email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
              initials: email.split('@')[0].split(/[._]/).map(n => n[0].toUpperCase()).join(''),
              created: firebase.database.ServerValue.TIMESTAMP
            };
            return db.ref("users/" + userCredential.user.uid).set(userData)
              .then(() => db.ref("users/" + userCredential.user.uid).once("value"));
          });
      }
      throw error;
    })
    .then(snapshot => {
      if (!snapshot.exists()) {
        throw new Error('No user data found');
      }
      window.location.reload();
    })
    .catch(error => {
      console.error('Login error:', error);
      document.getElementById("loginError").textContent = "‚ùå " + error.message;
    });
}

function logout() {
  auth.signOut().then(() => {
    window.location.reload();
  }).catch(error => {
    console.error('Logout error:', error);
    alert('Error during logout: ' + error.message);
  });
}

function setupUIForRole(role) {
  const isAdmin = role === 'admin';
  const isOperator = role === 'operator';
  
  // Allow operators to save inspections and view history
  document.getElementById("importFile").disabled = !isAdmin;
  document.querySelectorAll("#controlPanel button").forEach(btn => {
    if (btn.innerText.includes('Logout')) return;
    if (btn.innerText.includes('Export CSV') || btn.innerText.includes('Backup JSON')) {
      btn.disabled = !isAdmin && !isOperator;
    } else {
      btn.disabled = !isAdmin;
    }
    btn.style.opacity = btn.disabled ? 0.5 : 1;
  });
}

function initMap() {
  // Add custom CSS to ensure markers are always on top
  const customCSS = `
    .gully-marker {
      z-index: 1000 !important;
    }
    .dot {
      z-index: 1000 !important;
      opacity: 1 !important;
    }
    .leaflet-marker-icon {
      z-index: 1000 !important;
    }
    .leaflet-marker-pane {
      z-index: 600 !important;
    }
    .leaflet-popup-pane {
      z-index: 700 !important;
    }
  `;
  const style = document.createElement('style');
  style.textContent = customCSS;
  document.head.appendChild(style);

  map = L.map('map', {
    preferCanvas: false,
    zoomControl: true,
    maxZoom: 19
  }).setView([51.9, -8.5], 13);
  
  // Add tile layer with explicit z-index
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    zIndex: 100
  }).addTo(map);
  
  // Add scale control
  L.control.scale().addTo(map);

  // Add all layers to map
  Object.values(layers).forEach(layer => layer.addTo(map));
  
  initLayerToggles();
  
  document.getElementById('importFile').addEventListener('change', handleKMLImport);
}

function initLayerToggles() {
  // Add click handlers for layer toggle buttons
  document.querySelectorAll('.layer-toggle').forEach(button => {
    const layerName = button.dataset.layer;
    
    // Update the icon in the button
    const icon = button.querySelector('span');
    if (layerName === 'playgrounds' || layerName === 'parks') {
      icon.innerHTML = '‚ñ≤'; // Triangle symbol
      icon.style.fontSize = '12px';
    }
    
    button.addEventListener('click', () => {
      const isActive = button.classList.toggle('active');
      button.style.background = isActive ? '#e0e0e0' : '#f0f0f0';
      if (isActive) {
        layers[layerName].addTo(map);
      } else {
        map.removeLayer(layers[layerName]);
      }
    });
    // Start with all layers active
    button.classList.add('active');
    button.style.background = '#e0e0e0';
  });

  // Add change handler for active layer dropdown
  document.getElementById('activeLayer').addEventListener('change', (e) => {
    currentActiveLayer = e.target.value;
  });
}

function getStatusColor(status) {
  const statusColors = {
    // Gully statuses
    'Clear': '#4CAF50',      // Green
    'Blocked': '#FF9800',    // Orange
    'Broken': '#f44336',     // Red
    'Remediation': '#9C27B0', // Purple
    'Replacement': '#795548', // Brown
    'Expired': '#607D8B',    // Blue Grey
    'Unmarked': '#9E9E9E',   // Grey

    // Signage statuses
    'Good': '#4CAF50',       // Green
    'Damaged': '#FF9800',    // Orange
    'Missing': '#f44336',    // Red

    // Playground statuses
    'Operational': '#4CAF50',     // Green
    'Needs Repair': '#FF9800',    // Orange
    'Out of Service': '#f44336',  // Red

    // Park statuses
    'Open': '#4CAF50',           // Green
    'Under Maintenance': '#FF9800', // Orange
    'Closed': '#f44336',         // Red

    // Walkway statuses
    'Obstructed': '#FF9800',     // Orange
    'Under Repair': '#9C27B0',   // Purple

    // Lining statuses
    'Faded': '#FF9800',          // Orange
    'Needs Repainting': '#f44336' // Red
  };

  return statusColors[status] || '#9E9E9E'; // Default to grey if status not found
}

function createDot(color) {
  return L.divIcon({
    className: 'gully-marker',
    html: `<div class='dot' style='background:${color};width:14px;height:14px;border-radius:50%;border:2px solid #000;box-shadow:0 0 2px #fff, 0 0 4px #000;'></div>`,
    iconSize: [18, 18],
    iconAnchor: [9, 9],
    popupAnchor: [0, -9]
  });
}

function createTriangle(color) {
  return L.divIcon({
    className: 'triangle-marker',
    html: `<div style='width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:16px solid ${color};filter:drop-shadow(0 0 2px rgba(0,0,0,0.5));'></div>`,
    iconSize: [18, 18],
    iconAnchor: [9, 16],
    popupAnchor: [0, -16]
  });
}

function getMarkerIcon(layerType, status = 'Unmarked') {
  const color = getStatusColor(status);
  
  switch(layerType) {
    case 'playgrounds':
    case 'parks':
      return createTriangle(color);
    default:
      return createDot(color);
  }
}

function addGullyToMap(latlng, gullyId, layerType = 'gullies') {
  console.log('Adding marker to layer:', layerType);
  
  const marker = new L.Marker([latlng.lat, latlng.lng], {
    icon: getMarkerIcon(layerType)
  });
  
  // Add marker to appropriate layer
  if (layers[layerType]) {
    layers[layerType].addLayer(marker);
  } else {
    console.warn('Unknown layer type:', layerType);
    layers.gullies.addLayer(marker);
  }
  
  marker.on('click', () => {
    if (deleteMode) {
      handleGullyDelete(gullyId, marker, layerType);
    } else {
      currentMarker = marker;
      showInspectionPopup(marker, gullyId, latlng, layerType);
    }
  });
  
  marker.setZIndexOffset(1000);
  
  gullyData.push({ marker, id: gullyId, layer: layerType });
  return marker;
}

function handleKMLImport(event) {
  if (currentRole !== 'admin') {
    alert('Only administrators can import KML files');
    return;
  }

  const file = event.target.files[0];
  if (importedFiles.has(file.name)) {
    alert("This file has already been imported.");
    return;
  }
  
  importedFiles.add(file.name);
  const reader = new FileReader();
  
  reader.onload = async () => {
    try {
      console.log('File read successfully, parsing KML...');
      const kml = new DOMParser().parseFromString(reader.result, 'text/xml');
      const geojson = toGeoJSON.kml(kml);
      
      if (!geojson.features || geojson.features.length === 0) {
        alert('No valid points found in KML file');
        return;
      }

      console.log(`Found ${geojson.features.length} features in KML`);

      let pointsAdded = 0;
      let bounds = L.latLngBounds([]);
      let markers = [];
      
      // Process points
      for (const f of geojson.features) {
        if (f.geometry && f.geometry.type === 'Point' && f.geometry.coordinates) {
          const [lng, lat] = f.geometry.coordinates;
          
          if (isValidCoordinate(lng, lat)) {
            const itemId = `${currentActiveLayer}_${Date.now()}_${pointsAdded}`;
            
            try {
              // Create marker with current layer type
              const marker = new L.Marker([lat, lng], {
                icon: new L.DivIcon({
                  className: 'custom-div-icon',
                  html: "<div style='background-color:#808080;width:15px;height:15px;border-radius:50%;border:2px solid black'></div>",
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                })
              });
              
              // Add to appropriate layer
              layers[currentActiveLayer].addLayer(marker);
              
              // Set up click handler
              marker.on('click', () => {
                if (deleteMode) {
                  handleGullyDelete(itemId, marker, currentActiveLayer);
                } else {
                  showInspectionPopup(marker, itemId, { lat, lng }, currentActiveLayer);
                }
              });
              
              markers.push(marker);
              gullyData.push({ marker, id: itemId, layer: currentActiveLayer });
              bounds.extend([lat, lng]);
              pointsAdded++;
              
              // Save to Firebase under the current layer
              await db.ref(`${currentActiveLayer}/${itemId}`).set({
                location: { lat, lng },
                created: firebase.database.ServerValue.TIMESTAMP,
                createdBy: auth.currentUser.uid,
                status: 'Unmarked'
              });
              
            } catch (err) {
              console.error('Error creating marker:', err);
            }
          }
        }
      }
      
      if (pointsAdded > 0) {
        const paddedBounds = bounds.pad(0.2);
        map.fitBounds(paddedBounds);
        
        markers.forEach(marker => {
          if (marker) {
            marker.setZIndexOffset(1000);
          }
        });
        
        updateSummary();
        alert(`Successfully imported ${pointsAdded} points to ${layerNames[currentActiveLayer]} layer`);
      } else {
        alert('No valid points found in the KML file');
      }
    } catch (error) {
      console.error('Error in KML import:', error);
      alert('Error importing KML file: ' + error.message);
    }
  };
  
  reader.onerror = (error) => {
    console.error('Error reading file:', error);
    alert('Error reading file: ' + error.message);
  };
  
  reader.readAsText(file);
}

function isValidCoordinate(lng, lat) {
  return !isNaN(lng) && !isNaN(lat) && 
         lng >= -180 && lng <= 180 && 
         lat >= -90 && lat <= 90;
}

function showInspectionPopup(marker, gullyId, latlng, layerType) {
  // Close any existing popup first
  if (currentInspectionPopup) {
    map.closePopup(currentInspectionPopup);
  }

  const popupContent = document.createElement('div');
  popupContent.className = 'popup-form';
  popupContent.style.padding = '10px';

  // Create form HTML with proper event handling
  popupContent.innerHTML = `
    <div style="margin-bottom: 10px;">
      <label>
        <input type="checkbox" id="inspection-complete" style="margin-right: 5px;">
        Inspection Complete
      </label>
    </div>
    
    <div style="margin-bottom: 10px;">
      <label>Date:</label>
      <input type="date" id="inspection-date" 
        value="${new Date().toISOString().split('T')[0]}" 
        max="${new Date().toISOString().split('T')[0]}"
        style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 10px;">
      <label>Status:</label>
      <select id="inspection-status" style="width: 100%;">
        ${getStatusOptionsForLayer(layerType)}
      </select>
    </div>

    <div style="margin-bottom: 10px;">
      <label>Comments:</label>
      <textarea id="inspection-comment" placeholder="Add inspection comments..." style="width: 100%; height: 60px;"></textarea>
    </div>
    
    <div style="margin-bottom: 10px;">
      <label>Photo:</label>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <input type="file" id="inspection-photo" accept="image/*" style="width: 100%;">
        <button onclick="capturePhoto()" style="background: #2196F3; color: white; border: none; padding: 8px; border-radius: 4px; width: 100%;">
          üì∏ Take Picture
        </button>
      </div>
    </div>
    
    <div style="margin-top: 15px; display: flex; justify-content: space-between;">
      <button id="save-inspection-btn" style="flex: 1; margin-right: 10px; background: #4CAF50; color: white; border: none; padding: 8px; border-radius: 4px;">
        üíæ Save Inspection
      </button>
      <button onclick="viewGullyHistory('${gullyId}')" style="flex: 1; background: #2196F3; color: white; border: none; padding: 8px; border-radius: 4px;">
        üìã View History
      </button>
    </div>
  `;

  // Create popup
  const popup = L.popup({
    maxWidth: 300,
    className: 'inspection-popup',
    closeButton: true,
    autoClose: false,
    closeOnClick: false
  })
  .setLatLng(latlng)
  .setContent(popupContent);

  currentInspectionPopup = popup;
  marker.bindPopup(popup).openPopup();

  // Add event listener after the popup is added to DOM
  setTimeout(() => {
    const saveButton = document.getElementById('save-inspection-btn');
    if (saveButton) {
      saveButton.addEventListener('click', () => {
        saveInspection(gullyId, marker, layerType);
      });
    }
  }, 100);
}

function getStatusOptionsForLayer(layerType) {
  const options = {
    gullies: ['Clear', 'Blocked', 'Broken', 'Remediation', 'Replacement'],
    signage: ['Good', 'Damaged', 'Missing'],
    playgrounds: ['Operational', 'Needs Repair', 'Out of Service'],
    parks: ['Open', 'Under Maintenance', 'Closed'],
    walkways: ['Clear', 'Obstructed', 'Under Repair'],
    lining: ['Good', 'Faded', 'Needs Repainting']
  };

  return (options[layerType] || []).map(status => 
    `<option value="${status}">${status}</option>`
  ).join('');
}

// Update saveInspection to properly handle the status update
async function saveInspection(gullyId, marker, layerType) {
  if (!auth.currentUser) {
    alert('You must be logged in to save inspections');
    return;
  }

  const formData = {
    complete: document.getElementById('inspection-complete').checked,
    date: document.getElementById('inspection-date').value,
    status: document.getElementById('inspection-status').value,
    comment: document.getElementById('inspection-comment').value,
    location: marker.getLatLng()
  };

  if (!formData.complete) {
    alert('Please mark inspection as complete');
    return;
  }

  try {
    // Get current user data
    const userData = window.currentUserData;
    if (!userData) {
      throw new Error('User data not found. Please log out and log in again.');
    }

    // Get inspector info
    const inspectorInfo = {
      name: userData.name || auth.currentUser.email.split('@')[0].replace(/[._]/g, ' '),
      email: auth.currentUser.email,
      uid: auth.currentUser.uid,
      role: userData.role,
      initials: userData.initials || auth.currentUser.email.substring(0, 2).toUpperCase()
    };

    // Create inspection data
    const timestamp = Date.now();
    const inspectionData = {
      date: formData.date,
      status: formData.status,
      comment: formData.comment,
      complete: formData.complete,
      timestamp: timestamp,
      inspector: inspectorInfo
    };

    // Handle photo upload if present
    const photoFile = document.getElementById('inspection-photo').files[0];
    if (photoFile) {
      try {
        const photoRef = storage.ref(`photos/${gullyId}/${timestamp}_${photoFile.name}`);
        await photoRef.put(photoFile);
        inspectionData.photoURL = await photoRef.getDownloadURL();
      } catch (error) {
        console.error('Photo upload failed:', error);
        alert('Warning: Photo upload failed, but inspection will still be saved.');
      }
    }

    // Save inspection data
    const gullyRef = db.ref(`gullies/${gullyId}`);
    const updates = {
      [`inspections/${timestamp}`]: inspectionData,
      status: formData.status,
      lastInspection: timestamp,
      lastInspector: inspectorInfo
    };

    await gullyRef.update(updates);
    await db.ref(`gully_history/${gullyId}/${timestamp}`).set(inspectionData);

    // Update marker and UI
    updateMarkerStatus(marker, formData.status, layerType);
    updateSummary();
    
    // Show success message
    alert('Inspection saved successfully');
    
    // Clear form
    document.getElementById('inspection-complete').checked = false;
    document.getElementById('inspection-comment').value = '';
    document.getElementById('inspection-photo').value = '';
    
    // Keep popup open for another inspection
    showInspectionPopup(marker, gullyId, formData.location, layerType);

  } catch (error) {
    console.error('Save inspection error:', error);
    alert('Error saving inspection: ' + error.message);
  }
}

function capturePhoto() {
  try {
    const photoInput = document.getElementById('inspection-photo');
    // Create a temporary input for capturing photos
    const tempInput = document.createElement('input');
    tempInput.type = 'file';
    tempInput.accept = 'image/*';
    tempInput.capture = 'environment'; // Use the back camera
    
    // When a photo is selected, copy it to the main photo input
    tempInput.onchange = function() {
      if (this.files && this.files[0]) {
        photoInput.files = this.files;
      }
    };
    
    tempInput.click();
  } catch (error) {
    console.error('Error capturing photo:', error);
    alert('Error capturing photo. Please try again.');
  }
}

function updateMarkerStatus(marker, status, layerType = 'gullies') {
  marker.setIcon(getMarkerIcon(layerType, status));
}

async function viewGullyHistory(gullyId) {
  try {
    // Get history from both locations
    const [inspectionsSnapshot, historySnapshot] = await Promise.all([
      db.ref(`gullies/${gullyId}/inspections`).once('value'),
      db.ref(`gully_history/${gullyId}`).once('value')
    ]);
    
    // Combine and sort all inspections
    const allInspections = [];
    
    // Add inspections from main gully record
    if (inspectionsSnapshot.exists()) {
      Object.values(inspectionsSnapshot.val()).forEach(inspection => {
        allInspections.push(inspection);
      });
    }
    
    // Add inspections from history
    if (historySnapshot.exists()) {
      Object.values(historySnapshot.val()).forEach(inspection => {
        allInspections.push(inspection);
      });
    }
    
    // Sort by timestamp, most recent first
    allInspections.sort((a, b) => b.timestamp - a.timestamp);
    
    // Create history display
    const historyHtml = allInspections.map(inspection => {
      const date = new Date(inspection.timestamp).toLocaleString();
      const inspectorInfo = inspection.inspector || {};
      const inspectorName = inspectorInfo.name || 'Unknown';
      const inspectorInitials = inspectorInfo.initials || 'UN';
      const status = inspection.status || 'Unknown';
      const photoHtml = inspection.photoURL ? 
        `<br><a href="${inspection.photoURL}" target="_blank" style="color: blue;">üì∑ View Photo</a>` : '';
      
      return `
        <div style="border-bottom: 1px solid #ccc; margin-bottom: 10px; padding-bottom: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <strong style="font-size: 1.1em;">${date}</strong>
            <div>
              <span style="background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-weight: bold;">${inspectorInitials}</span>
            </div>
          </div>
          <div style="margin: 5px 0;">
            <span style="font-weight: bold;">Inspector:</span> ${inspectorName}
          </div>
          <div style="margin: 5px 0;">
            <span style="font-weight: bold;">Status:</span> 
            <span style="color: ${getStatusColor(status)};">${status}</span>
          </div>
          <div style="margin: 5px 0;">
            <span style="font-weight: bold;">Comments:</span><br>
            ${inspection.comment || 'None'}
          </div>
          ${photoHtml}
        </div>
      `;
    }).join('');
    
    // Create and show modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 10000;
    `;
    
    modal.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Inspection History</h3>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="border: none; background: #f0f0f0; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
          ‚úñ Close
        </button>
      </div>
      <div>${historyHtml || 'No inspection history available'}</div>
    `;
    
    document.body.appendChild(modal);
    
  } catch (error) {
    console.error('Error loading history:', error);
    alert('Error loading history: ' + error.message);
  }
}

function loadGullyData() {
  Object.keys(layers).forEach(layerType => {
    db.ref(layerType).on('value', snapshot => {
      const data = snapshot.val() || {};
      const existingIds = new Set(gullyData.filter(g => g.layer === layerType).map(g => g.id));
      
      Object.entries(data).forEach(([id, item]) => {
        if (!existingIds.has(id) && item.location) {
          const marker = addGullyToMap(item.location, id, layerType);
          if (item.status) {
            updateMarkerStatus(marker, item.status, layerType);
          }
        }
      });
    });
  });
}

// Initialize auth state listener
auth.onAuthStateChanged(user => {
  if (user) {
    console.log('User logged in:', user.email);
    db.ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val();
      if (!userData) {
        console.error('No user data found');
        return;
      }
      window.currentUserData = userData;
      currentRole = userData.role;
      
      document.getElementById('roleBanner').textContent = `Logged in as ${userData.role.toUpperCase()}`;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('map').style.display = 'block';
      document.getElementById('controlPanel').style.display = 'block';
      document.getElementById('summary').style.display = 'block';
      
      initMap();
      loadGullyData();
      setupUIForRole(userData.role);
      setupInactivityTracking();
    });
  } else {
    console.log('No user logged in');
    window.currentUserData = null;
    currentRole = null;
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('map').style.display = 'none';
    document.getElementById('controlPanel').style.display = 'none';
    document.getElementById('summary').style.display = 'none';
  }
});

// Update the updateSummary function to properly show gully counts
function updateSummary() {
  const counts = {
    'All': 0,
    'Clear': 0,
    'Blocked': 0,
    'Broken': 0,
    'Remediation': 0,
    'Replacement': 0,
    'Expired': 0,
    'Unmarked': 0
  };
  
  // Get all gullies from the layer
  const gullyMarkers = Array.from(layers.gullies.getLayers());
  
  gullyMarkers.forEach(marker => {
    const gully = gullyData.find(g => g.marker === marker);
    if (gully) {
      counts['All']++;
      const status = gully.status || 'Unmarked';
      if (counts.hasOwnProperty(status)) {
        counts[status]++;
      }
    }
  });
  
  // Update summary display
  let summaryHtml = '';
  Object.entries(counts).forEach(([status, count]) => {
    if (status !== 'All' || count > 0) { // Only show All if there are items
      const color = getStatusColor(status);
      summaryHtml += `
        <div style="margin: 5px 0; display: flex; align-items: center;">
          <span style="display: inline-block; width: 12px; height: 12px; background: ${color}; border-radius: 50%; margin-right: 5px; border: 1px solid #000;"></span>
          <span style="flex: 1;">${status}: ${count}</span>
        </div>
      `;
    }
  });
  
  document.getElementById('summaryContent').innerHTML = summaryHtml;
}
</script>
</body>
</html>