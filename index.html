<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gully Inspection System - Login</title>
  <meta name="viewport" content="width=600, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      background: #232323;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #loginBg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: url('cork_city_hall_night.jpg') center center/cover no-repeat;
      z-index: 0;
      display: none;
    }
    #loginBgOverlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(30,30,30,0.45);
      z-index: 1;
      display: none;
    }
    .login-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.18), 0 1.5px 6px rgba(0,0,0,0.10);
      padding: 2.5rem 2.2rem 2rem 2.2rem;
      max-width: 410px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }
    .login-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1.2rem;
    }
    .login-header img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      margin-bottom: 0.7rem;
    }
    .login-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 1.2rem;
      text-align: center;
    }
    .login-form label {
      font-weight: 500;
      color: #333;
    }
    .login-form input[type="email"],
    .login-form input[type="password"],
    .login-form input[type="text"],
    .login-form input[type="date"],
    .login-form input[type="time"],
    .login-form select,
    .login-form textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-bottom: 0.7rem;
      font-size: 1.08em;
      padding: 0.7em 1em;
      background: #f8fafc;
      transition: border 0.2s;
    }
    .login-form input:focus,
    .login-form select:focus,
    .login-form textarea:focus {
      border: 1.5px solid #007bff;
      outline: none;
      background: #fff;
    }
    .login-form .btn-primary {
      background: #007bff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1em;
      margin-top: 0.5em;
      margin-bottom: 0.5em;
      box-shadow: 0 2px 8px rgba(0,123,255,0.08);
      transition: background 0.2s;
    }
    .login-form .btn-primary:hover {
      background: #0056b3;
    }
    .login-form .btn-outline-secondary {
      border-radius: 8px;
      font-size: 1.08em;
      margin-bottom: 0.5em;
    }
    .login-form .form-check-label {
      font-size: 1em;
      color: #444;
    }
    .login-form .form-check-input {
      margin-top: 0.2em;
    }
    .login-form .text-danger {
      font-size: 0.98em;
      margin-bottom: 0.5em;
    }
    .login-form .text-success {
      font-size: 0.98em;
      margin-bottom: 0.5em;
    }
    .login-form a {
      color: #007bff;
      text-decoration: none;
      font-size: 0.98em;
    }
    .login-form a:hover {
      text-decoration: underline;
    }
    @media (max-width: 600px) {
      .login-card {
        padding: 1.2rem 0.5rem 1.2rem 0.5rem;
        max-width: 98vw;
      }
      .login-header img {
        width: 90px;
        height: 90px;
      }
      .login-title {
        font-size: 1.1rem;
      }
    }
    #functionToolbar {
      display: none !important;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      height: 56px;
      z-index: 1200;
    }
    #mainApp {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: calc(100vh - 56px);
      z-index: 1;
      overflow: hidden;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- LOGIN PAGE HEADER -->
  <div id="loginBg"></div>
  <div id="loginBgOverlay"></div>
  <div class="container d-flex align-items-center justify-content-center" style="min-height:100vh; position:relative; z-index:2; background:transparent;" id="loginContainer">
    <div class="login-card">
      <div class="login-header">
        <img src="cork-city-council-logo.jpg" alt="Cork City Council Logo">
        <div style="font-weight:700; text-align:center; width:100%;">CORK CITY COUNCIL</div>
      </div>
      <div class="login-title">Asset Management System (Roads)</div>
      <div class="login-form">
        <form id="loginForm">
          <div class="mb-3">
            <label for="email" class="form-label">Username</label>
            <input type="email" id="email" class="form-control" required autocomplete="username">
          </div>
          <div class="mb-3 position-relative">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" class="form-control pr-5" required autocomplete="current-password">
            <button type="button" id="togglePassword" tabindex="-1" style="position:absolute;top:calc(50% + 16px);right:10px;transform:translateY(-50%);background:transparent;border:none;outline:none;" aria-label="Show/Hide Password">
              <i id="togglePasswordIcon" class="bi bi-eye"></i>
            </button>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="rememberMe">
            <label class="form-check-label" for="rememberMe">Remember Me</label>
          </div>
          <div class="mb-2">
            <a href="#" id="forgotPasswordLink" style="font-size:0.95em;">Forgot Password?</a>
          </div>
          <div id="loginError" class="text-danger mb-2"></div>
          <button type="submit" class="btn btn-primary w-100">Sign In</button>
        </form>
        <button id="registerBtn" class="btn btn-outline-secondary w-100 mt-2">Register</button>
      </div>
    </div>
  </div>
  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerModalLabel">Register New Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-2">
              <label for="regName" class="form-label">Name</label>
              <input type="text" class="form-control" id="regName" required>
            </div>
            <div class="mb-2">
              <label for="regEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="regEmail" required>
            </div>
            <div class="mb-2">
              <label for="regPassword" class="form-label">Password</label>
              <input type="password" class="form-control" id="regPassword" required>
            </div>
            <div class="mb-2">
              <label for="regPassword2" class="form-label">Confirm Password</label>
              <input type="password" class="form-control" id="regPassword2" required>
            </div>
            <div id="registerMsg" class="mb-2"></div>
            <button type="submit" class="btn btn-success w-100">Register</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Forgot Password Modal -->
  <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="forgotPasswordForm">
            <div class="mb-3">
              <label for="forgotEmail" class="form-label">Enter your email address</label>
              <input type="email" class="form-control" id="forgotEmail" required>
            </div>
            <div id="forgotPasswordMsg" class="mb-2"></div>
            <button type="submit" class="btn btn-primary w-100">Send Reset Email</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ASSET FILTER UI -->
  <div id="assetFilterBar" style="display:none; position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:8px 16px;">
    <label class="me-3"><input type="checkbox" id="filterGullies" checked> Gullies</label>
    <label><input type="checkbox" id="filterParks" checked> Parks</label>
  </div>

  <!-- MAIN APP CONTAINER -->
  <div id="mainApp" style="display:none; height:calc(100vh - 56px); width:100vw; position:relative; overflow:hidden;">
    <div id="map" style="height:100%; width:100%;"></div>
  </div>

  <!-- TASKS BUTTON AND MODAL -->
  <div class="modal fade" id="tasksModal" tabindex="-1" aria-labelledby="tasksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tasksModalLabel">Tasks / Work Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="tasksList"></div>
          <div id="newTaskFormContainer" style="display:none;">
            <hr>
            <h6>Create New Task</h6>
            <form id="newTaskForm">
              <div class="mb-2">
                <input type="text" class="form-control" name="assetId" placeholder="Asset ID (e.g., from map popup)" required>
              </div>
              <div class="mb-2">
                <input type="text" class="form-control" name="assignedTo" placeholder="Assign to User UID" required>
              </div>
              <div class="mb-2">
                <input type="text" class="form-control" name="description" placeholder="Task Description" required>
              </div>
              <div class="mb-2">
                <select class="form-select" name="status" required>
                  <option value="Assigned">Assigned</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Create Task</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORTING BUTTON AND MODAL -->
  <div class="modal fade" id="reportingModal" tabindex="-1" aria-labelledby="reportingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportingModalLabel">Reporting & Analytics</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="assetCounts"></div>
          <canvas id="assetChart" height="120"></canvas>
          <button class="btn btn-outline-success mt-3" onclick="exportAssetsToCSV()">Export Assets to CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUMMARY MODAL -->
  <div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="summaryModalLabel">Gully Status Summary</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="summaryBody">
          Loading summary...
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet Omnivore plugin for KML/GPX support -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- BOTTOM TOOLBAR (RIBBON) -->
  <div id="functionToolbar" class="bottom-toolbar bg-light border-top d-flex align-items-center justify-content-between px-2" style="position:fixed;bottom:0;left:0;width:100vw;height:56px;z-index:1200;display:none;">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-secondary toolbar-button" id="logoutBtn" title="Logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
      <button class="btn btn-outline-secondary toolbar-button" id="usersBtn" title="User Management" onclick="showUserManagement()"><i class="bi bi-people"></i> Users</button>
      <button class="btn btn-outline-secondary toolbar-button" id="resetBtn" title="Reset" onclick="resetMap()"><i class="bi bi-arrow-repeat"></i> Reset</button>
      <button class="btn btn-outline-secondary toolbar-button" id="mapsBtn" title="Maps" onclick="showMapOptions()"><i class="bi bi-map"></i> Maps</button>
      <button class="btn btn-outline-secondary toolbar-button" id="layersBtn" title="Layers" onclick="showLayerControl()"><i class="bi bi-layers"></i> Layers</button>
      <button class="btn btn-outline-secondary toolbar-button" id="importBtn" title="Import" onclick="importData()"><i class="bi bi-upload"></i> Import</button>
      <button class="btn btn-outline-secondary toolbar-button" id="exportBtn" title="Export Backup" onclick="exportData()"><i class="bi bi-download"></i> Export Backup</button>
      <button class="btn btn-outline-secondary toolbar-button" id="editBtn" title="Edit" onclick="enableEditMode()"><i class="bi bi-pencil"></i> Edit</button>
      <button class="btn btn-outline-secondary toolbar-button" id="deleteBtn" title="Delete" onclick="enableDeleteMode()"><i class="bi bi-trash"></i> Delete</button>
      <button class="btn btn-outline-secondary toolbar-button" id="addBtn" title="Add" onclick="enableAddMode()"><i class="bi bi-plus"></i> Add</button>
      <button class="btn btn-outline-warning toolbar-button" id="summaryBtn" title="Summary" onclick="showSummaryPopup()"><i class="bi bi-bar-chart"></i> Summary</button>
      <button class="btn btn-outline-success toolbar-button" id="tasksBtn" title="Tasks" onclick="showTasksModal()"><i class="bi bi-list-task"></i> Tasks</button>
      <button class="btn btn-outline-info toolbar-button" id="reportingBtn" title="Reporting" onclick="showReportingModal()"><i class="bi bi-graph-up"></i> Reporting</button>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="userInfo" class="fw-bold"></span>
    </div>
  </div>

  <!-- LAYERS SELECTION MODAL -->
  <div class="modal fade" id="layersModal" tabindex="-1" aria-labelledby="layersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="layersModalLabel">Select Map Layers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="layersForm">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="layerGullies" checked>
              <label class="form-check-label" for="layerGullies">Gullies</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="layerParks" checked>
              <label class="form-check-label" for="layerParks">Parks/Playgrounds</label>
            </div>
            <!-- Add more layers as needed -->
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MAPS BASEMAP SELECTION MODAL -->
  <div class="modal fade" id="mapsModal" tabindex="-1" aria-labelledby="mapsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapsModalLabel">Select Map Type</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="mapsForm">
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="basemap" id="basemapStreet" value="street" checked>
              <label class="form-check-label" for="basemapStreet">Street Map</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="basemap" id="basemapSatellite" value="satellite">
              <label class="form-check-label" for="basemapSatellite">Satellite</label>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- USERS LIST MODAL (Admins only) -->
  <div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="usersModalLabel">All Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-sm table-striped">
            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Last Login</th></tr></thead>
            <tbody id="usersTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- RESET CONFIRMATION MODAL -->
  <div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resetConfirmModalLabel">Confirm Reset</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="resetConfirmForm">
            <div class="mb-3">
              <label for="resetPassword" class="form-label">Enter your password to confirm reset:</label>
              <input type="password" class="form-control" id="resetPassword" required autocomplete="current-password">
            </div>
            <div id="resetConfirmMsg" class="mb-2"></div>
            <button type="submit" class="btn btn-danger w-100">Confirm Reset</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBsteq-tHQdiDcRk5UBg52AwAxpVcq67cw",
      authDomain: "gullytest3.firebaseapp.com",
      databaseURL: "https://gullytest3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gullytest3",
      storageBucket: "gullytest3.firebasestorage.app",
      messagingSenderId: "876083677912",
      appId: "1:876083677912:web:065de0c7cca446b78f65ad"
    };
    firebase.initializeApp(firebaseConfig);

    window.currentUserRole = null;

    // Show/hide UI based on role
    function updateUIForRole(role) {
      // Example: show/hide admin panel, operator tools, etc.
      // document.getElementById('adminPanel').style.display = (role === 'admin') ? 'block' : 'none';
      // document.getElementById('operatorTools').style.display = (role === 'operator') ? 'block' : 'none';
      // document.getElementById('viewerPanel').style.display = (role === 'viewer') ? 'block' : 'none';
      // document.getElementById('contractorPanel').style.display = (role === 'contractor') ? 'block' : 'none';
      // Add your own logic for showing/hiding features
    }

    // Handle login form submit
    function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      document.getElementById('loginError').textContent = '';
      firebase.auth().setPersistence(rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION)
        .then(() => {
          return firebase.auth().signInWithEmailAndPassword(email, password);
        })
        .catch(error => {
          document.getElementById('loginError').textContent = error.message;
          throw error;
        });
    }
    window.login = login;

    document.addEventListener('DOMContentLoaded', function() {
      // Attach login form handler
      var loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          login();
          return false;
        });
      }
    });

    // Auth state change handler
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // Fetch user role from database
        firebase.database().ref('/users/' + user.uid + '/role').once('value').then(function(snapshot) {
          const role = snapshot.val() || 'viewer';
          window.currentUserRole = role;
          updateUIForRole(role);
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
        }).catch(function(error) {
          document.getElementById('loginError').textContent = 'Could not fetch user role: ' + error.message;
          firebase.auth().signOut();
        });
      } else {
        window.currentUserRole = null;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
      }
    });

    // Logout function
    function logout() {
      firebase.auth().signOut();
    }
    window.logout = logout;

    // Utility: get current user info
    function getCurrentUserInfo() {
      const user = firebase.auth().currentUser;
      return {
        uid: user ? user.uid : null,
        email: user ? user.email : null,
        role: window.currentUserRole || 'viewer'
      };
    }

    // Utility: check if user can add logs
    function canAddLogs() {
      const role = (window.currentUserRole || '').toLowerCase();
      return role === 'admin' || role === 'operator' || role === 'contractor';
    }

    // Fetch logs for an asset
    function fetchAssetLogs(assetId, callback) {
      firebase.database().ref('/assetLogs/' + assetId).orderByChild('timestamp').once('value', function(snapshot) {
        const logs = [];
        snapshot.forEach(child => logs.push(child.val()));
        callback(logs.reverse()); // Most recent first
      });
    }

    // Add a new log for an asset
    function addAssetLog(assetId, log, file, callback) {
      const newLogRef = firebase.database().ref('/assetLogs/' + assetId).push();
      const logId = newLogRef.key;
      if (file) {
        const storageRef = firebase.storage().ref(`/assetLogs/${assetId}/${logId}`);
        const uploadTask = storageRef.put(file);
        uploadTask.on('state_changed', null, function(error) {
          callback(error);
        }, function() {
          uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
            log.photoUrl = downloadURL;
            newLogRef.set(log, callback);
          });
        });
      } else {
        newLogRef.set(log, callback);
      }
    }

    // Enhanced popup for KML/GPX features (Gullies only)
    function assetPopupHtml(props, assetId) {
      let html = `<b>${props.name || 'Asset'}</b><br>`;
      if (props.description || props.desc) html += `${props.description || props.desc}<br>`;
      for (const key in props) {
        if (key !== 'name' && key !== 'description' && key !== 'desc') {
          html += `<b>${key}:</b> ${props[key]}<br>`;
        }
      }
      html += `<hr><div id="logs_${assetId}">Loading logs...</div>`;
      if (canAddLogs()) {
        html += `<form id="logForm_${assetId}" style="margin-top:8px;" enctype="multipart/form-data">
          <select name="status" class="form-select form-select-sm mb-1" required>
            <option value="">Status</option>
            <option>Inspected</option>
            <option>Needs Maintenance</option>
            <option>Completed</option>
          </select>
          <textarea name="notes" class="form-control form-control-sm mb-1" placeholder="Notes" rows="2"></textarea>
          <input type="file" name="photo" accept="image/*" class="form-control form-control-sm mb-1">
          <button type="submit" class="btn btn-sm btn-primary w-100">Add Log</button>
        </form>`;
      }
      return html;
    }

    // Update log display to show photo if present
    function renderLogs(logs) {
      return logs.map(log => `<div class='border-bottom mb-1 pb-1'><b>${log.status}</b> <span style='font-size:0.9em;'>(${new Date(log.timestamp).toLocaleString()})</span><br>${log.notes ? log.notes : ''}<br>${log.photoUrl ? `<img src='${log.photoUrl}' style='max-width:100%;max-height:120px;margin:4px 0;border-radius:4px;'><br>` : ''}<span style='font-size:0.85em;color:#888;'>by ${log.userEmail || 'unknown'}</span></div>`).join('');
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Only initialize the map if the main app is visible
      if (document.getElementById('mainApp')) {
        // Wait for auth state to show mainApp
        let mapInstance = null;
        let kmlLayer = null;
        let gpxLayer = null;
        function showAssetFilterBar(show) {
          document.getElementById('assetFilterBar').style.display = show ? 'block' : 'none';
        }
        function initMap() {
          if (mapInstance) return; // Prevent double init
          mapInstance = L.map('map').setView([51.8985, -8.4756], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(mapInstance);
          // KML Layer (example: gullies.kml)
          kmlLayer = omnivore.kml('gullies.kml', null, L.geoJson(null, {
            onEachFeature: function(feature, layer) {
              const props = feature.properties || {};
              const assetId = props.name || props.id || Math.random().toString(36).substr(2, 9);
              layer.bindPopup({
                maxWidth: 340,
                minWidth: 220,
                autoPan: true,
                closeButton: true,
                className: 'asset-popup',
                html: `<b>${props.name || 'Gully'}</b><br>
                  <form id="inspectionForm_${assetId}" enctype="multipart/form-data" style="margin-top:8px;">
                    <div class="mb-1">
                      <label class="form-label mb-0">Date</label>
                      <input type="date" name="date" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-1">
                      <label class="form-label mb-0">Time</label>
                      <input type="time" name="time" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-1">
                      <label class="form-label mb-0">Status</label>
                      <select name="status" class="form-select form-select-sm" required>
                        <option value="">Select status</option>
                        <option>Clear</option>
                        <option>Blocked</option>
                        <option>Broken</option>
                        <option>Remediation</option>
                        <option>Replacement</option>
                      </select>
                    </div>
                    <div class="mb-1">
                      <label class="form-label mb-0">Photo</label>
                      <input type="file" name="photo" accept="image/*" class="form-control form-control-sm">
                    </div>
                    <div class="mb-1">
                      <label class="form-label mb-0">Comment</label>
                      <textarea name="comment" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    <div class="form-check mb-1">
                      <input class="form-check-input" type="checkbox" name="confirm" id="confirm_${assetId}" required>
                      <label class="form-check-label" for="confirm_${assetId}">I confirm this inspection is accurate</label>
                    </div>
                    <div id="inspectionMsg_${assetId}" class="mb-1"></div>
                    <button type="submit" class="btn btn-success btn-sm w-100">Save Inspection</button>
                  </form>`
              });
              layer.on('popupopen', function(e) {
                // Fetch and display logs
                fetchAssetLogs(assetId, function(logs) {
                  const logsDiv = document.getElementById('logs_' + assetId);
                  if (logsDiv) {
                    if (logs.length === 0) {
                      logsDiv.innerHTML = '<i>No logs yet.</i>';
                    } else {
                      logsDiv.innerHTML = renderLogs(logs);
                    }
                  }
                });
                // Add log form handler
                if (canAddLogs()) {
                  const form = document.getElementById('logForm_' + assetId);
                  if (form) {
                    form.onsubmit = function(ev) {
                      ev.preventDefault();
                      const status = form.status.value;
                      const notes = form.notes.value;
                      const user = getCurrentUserInfo();
                      const fileInput = form.photo;
                      const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
                      const log = {
                        status,
                        notes,
                        timestamp: Date.now(),
                        userId: user.uid,
                        userEmail: user.email
                      };
                      addAssetLog(assetId, log, file, function(err) {
                        if (!err) {
                          fetchAssetLogs(assetId, function(logs) {
                            const logsDiv = document.getElementById('logs_' + assetId);
                            if (logsDiv) {
                              logsDiv.innerHTML = renderLogs(logs);
                            }
                          });
                          form.reset();
                        }
                      });
                    };
                  }
                }
              });
            }
          })).on('ready', function() {
            mapInstance.fitBounds(kmlLayer.getBounds());
          }).addTo(mapInstance);
          // GPX Layer (example: parks.gpx)
          gpxLayer = omnivore.gpx('parks.gpx', null, L.geoJson(null, {
            onEachFeature: function(feature, layer) {
              const props = feature.properties || {};
              const assetId = props.name || props.id || Math.random().toString(36).substr(2, 9);
              layer.bindPopup({
                maxWidth: 320,
                minWidth: 220,
                autoPan: true,
                closeButton: true,
                className: 'asset-popup',
                html: assetPopupHtml(props, assetId)
              });
              layer.on('popupopen', function(e) {
                // Fetch and display logs
                fetchAssetLogs(assetId, function(logs) {
                  const logsDiv = document.getElementById('logs_' + assetId);
                  if (logsDiv) {
                    if (logs.length === 0) {
                      logsDiv.innerHTML = '<i>No logs yet.</i>';
                    } else {
                      logsDiv.innerHTML = renderLogs(logs);
                    }
                  }
                });
                // Add log form handler
                if (canAddLogs()) {
                  const form = document.getElementById('logForm_' + assetId);
                  if (form) {
                    form.onsubmit = function(ev) {
                      ev.preventDefault();
                      const status = form.status.value;
                      const notes = form.notes.value;
                      const user = getCurrentUserInfo();
                      const fileInput = form.photo;
                      const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
                      const log = {
                        status,
                        notes,
                        timestamp: Date.now(),
                        userId: user.uid,
                        userEmail: user.email
                      };
                      addAssetLog(assetId, log, file, function(err) {
                        if (!err) {
                          fetchAssetLogs(assetId, function(logs) {
                            const logsDiv = document.getElementById('logs_' + assetId);
                            if (logsDiv) {
                              logsDiv.innerHTML = renderLogs(logs);
                            }
                          });
                          form.reset();
                        }
                      });
                    };
                  }
                }
              });
            }
          })).addTo(mapInstance);
          // Layer control
          const baseLayers = {};
          const overlays = {
            'Gullies (KML)': kmlLayer,
            'Parks (GPX)': gpxLayer
          };
          L.control.layers(baseLayers, overlays).addTo(mapInstance);
          // Asset filter UI logic
          showAssetFilterBar(true);
          document.getElementById('filterGullies').addEventListener('change', function() {
            if (this.checked) {
              mapInstance.addLayer(kmlLayer);
            } else {
              mapInstance.removeLayer(kmlLayer);
            }
          });
          document.getElementById('filterParks').addEventListener('change', function() {
            if (this.checked) {
              mapInstance.addLayer(gpxLayer);
            } else {
              mapInstance.removeLayer(gpxLayer);
            }
          });
        }
        // Listen for mainApp becoming visible
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(m) {
            if (m.target.style.display !== 'none') {
              setTimeout(initMap, 100); // Delay to ensure DOM is ready
            }
          });
        });
        observer.observe(document.getElementById('mainApp'), { attributes: true, attributeFilter: ['style'] });
        // If already visible (e.g., after login), init immediately
        if (document.getElementById('mainApp').style.display !== 'none') {
          setTimeout(initMap, 100);
        }
      }
    });

    // TASKS LOGIC
    let tasksModal = null;
    let highlightLayer = null;
    function showTasksModal() {
      if (!tasksModal) {
        tasksModal = new bootstrap.Modal(document.getElementById('tasksModal'));
      }
      loadTasksForUser();
      tasksModal.show();
    }
    function loadTasksForUser() {
      const user = getCurrentUserInfo();
      const isAdmin = user.role === 'admin';
      firebase.database().ref('/tasks').once('value', function(snapshot) {
        const tasks = [];
        snapshot.forEach(child => {
          const t = child.val();
          t._id = child.key;
          if (isAdmin || t.assignedTo === user.uid) tasks.push(t);
        });
        renderTasksList(tasks, isAdmin);
      });
    }
    // Update renderTasksList to include photo upload in the update form and display photo if present
    function renderTasksList(tasks, isAdmin) {
      const listDiv = document.getElementById('tasksList');
      if (!tasks.length) {
        listDiv.innerHTML = '<i>No tasks found.</i>';
        return;
      }
      listDiv.innerHTML = tasks.map(t => `
        <div class='border-bottom mb-2 pb-2'>
          <b>Asset:</b> ${t.assetId}<br>
          <b>Assigned to:</b> ${t.assignedTo}<br>
          <b>Description:</b> ${t.description}<br>
          <b>Status:</b> <span id='taskStatus_${t._id}'>${t.status}</span><br>
          <b>Notes:</b> <span id='taskNotes_${t._id}'>${t.notes || ''}</span><br>
          ${t.photoUrl ? `<img src='${t.photoUrl}' style='max-width:100%;max-height:120px;margin:4px 0;border-radius:4px;'><br>` : ''}
          <button class='btn btn-sm btn-outline-primary mt-1' onclick='highlightAssetOnMap("${t.assetId}")'>Show Asset</button>
          ${isAdmin ? '' : `<form class='mt-2' onsubmit='updateTaskStatus(event, "${t._id}")' enctype='multipart/form-data'>
            <select class='form-select form-select-sm mb-1' name='status' required>
              <option value=''>Update Status</option>
              <option>In Progress</option>
              <option>Completed</option>
            </select>
            <input type='text' class='form-control form-control-sm mb-1' name='notes' placeholder='Notes'>
            <input type='file' name='photo' accept='image/*' class='form-control form-control-sm mb-1'>
            <button type='submit' class='btn btn-sm btn-success'>Update</button>
          </form>`}
        </div>
      `).join('');
      // Show new task form for admins
      document.getElementById('newTaskFormContainer').style.display = isAdmin ? 'block' : 'none';
    }
    // Update updateTaskStatus to handle photo upload
    function updateTaskStatus(ev, taskId) {
      ev.preventDefault();
      const form = ev.target;
      const status = form.status.value;
      const notes = form.notes.value;
      const fileInput = form.photo;
      const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
      if (file) {
        const storageRef = firebase.storage().ref(`/tasks/${taskId}/evidence`);
        const uploadTask = storageRef.put(file);
        uploadTask.on('state_changed', null, function(error) {
          alert('Photo upload failed: ' + error.message);
        }, function() {
          uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
            firebase.database().ref('/tasks/' + taskId).update({ status, notes, photoUrl: downloadURL }, function(err) {
              if (!err) {
                document.getElementById('taskStatus_' + taskId).textContent = status;
                document.getElementById('taskNotes_' + taskId).textContent = notes;
                loadTasksForUser();
                form.reset();
              }
            });
          });
        });
      } else {
        firebase.database().ref('/tasks/' + taskId).update({ status, notes }, function(err) {
          if (!err) {
            document.getElementById('taskStatus_' + taskId).textContent = status;
            document.getElementById('taskNotes_' + taskId).textContent = notes;
            loadTasksForUser();
            form.reset();
          }
        });
      }
    }
    function highlightAssetOnMap(assetId) {
      // Remove previous highlight
      if (highlightLayer && mapInstance) {
        mapInstance.removeLayer(highlightLayer);
        highlightLayer = null;
      }
      // Try to find the asset marker by assetId (name property)
      let found = false;
      [kmlLayer, gpxLayer].forEach(layer => {
        if (layer && layer.eachLayer) {
          layer.eachLayer(function(l) {
            if (l.feature && (l.feature.properties.name === assetId || l.feature.properties.id === assetId)) {
              highlightLayer = L.circleMarker(l.getLatLng(), { radius: 18, color: 'red', weight: 3, fillOpacity: 0.1 }).addTo(mapInstance);
              mapInstance.setView(l.getLatLng(), 16);
              found = true;
            }
          });
        }
      });
      if (!found) alert('Asset not found on map.');
    }
    // New task form handler
    if (document.getElementById('newTaskForm')) {
      document.getElementById('newTaskForm').onsubmit = function(ev) {
        ev.preventDefault();
        const assetId = this.assetId.value.trim();
        const assignedTo = this.assignedTo.value.trim();
        const description = this.description.value.trim();
        const status = this.status.value;
        const task = { assetId, assignedTo, description, status, created: Date.now() };
        firebase.database().ref('/tasks').push(task, function(err) {
          if (!err) {
            loadTasksForUser();
            document.getElementById('newTaskForm').reset();
          }
        });
      };
    }
    // Show tasks button after login
    function showTasksButton(show) {
      document.getElementById('tasksBtn').style.display = show ? 'block' : 'none';
    }
    // Show tasks button when main app is visible
    const tasksBtn = document.getElementById('tasksBtn');
    if (tasksBtn) {
      tasksBtn.onclick = showTasksModal;
    }
    // Show/hide tasks button on auth state change
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        showTasksButton(true);
      } else {
        showTasksButton(false);
      }
    });

    // REPORTING LOGIC
    let reportingModal = null;
    function showReportingModal() {
      if (!reportingModal) {
        reportingModal = new bootstrap.Modal(document.getElementById('reportingModal'));
      }
      loadAssetCountsAndChart();
      reportingModal.show();
    }
    function loadAssetCountsAndChart() {
      // Count assets by type from KML/GPX layers
      let gullyCount = 0, parkCount = 0;
      let statusCounts = { 'Inspected': 0, 'Needs Maintenance': 0, 'Completed': 0 };
      if (kmlLayer && kmlLayer.eachLayer) {
        kmlLayer.eachLayer(function(l) { gullyCount++; });
      }
      if (gpxLayer && gpxLayer.eachLayer) {
        gpxLayer.eachLayer(function(l) { parkCount++; });
      }
      // Count statuses from logs
      firebase.database().ref('/assetLogs').once('value', function(snapshot) {
        snapshot.forEach(assetSnap => {
          assetSnap.forEach(logSnap => {
            const log = logSnap.val();
            if (log.status && statusCounts[log.status] !== undefined) {
              statusCounts[log.status]++;
            }
          });
        });
        // Update UI
        document.getElementById('assetCounts').innerHTML = `
          <b>Asset Counts:</b><br>
          Gullies: ${gullyCount}<br>
          Parks: ${parkCount}<br>
          <b>Status Counts:</b><br>
          Inspected: ${statusCounts['Inspected']}<br>
          Needs Maintenance: ${statusCounts['Needs Maintenance']}<br>
          Completed: ${statusCounts['Completed']}<br>
        `;
        // Chart
        const ctx = document.getElementById('assetChart').getContext('2d');
        if (window.assetChartInstance) window.assetChartInstance.destroy();
        window.assetChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Gullies', 'Parks', 'Inspected', 'Needs Maintenance', 'Completed'],
            datasets: [{
              label: 'Count',
              data: [gullyCount, parkCount, statusCounts['Inspected'], statusCounts['Needs Maintenance'], statusCounts['Completed']],
              backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8']
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      });
    }
    function exportAssetsToCSV() {
      let rows = [['Asset Type','Name','Lat','Lng']];
      if (kmlLayer && kmlLayer.eachLayer) {
        kmlLayer.eachLayer(function(l) {
          if (l.feature && l.feature.geometry && l.feature.geometry.coordinates) {
            const props = l.feature.properties || {};
            const coords = l.getLatLng();
            rows.push(['Gully', props.name || '', coords.lat, coords.lng]);
          }
        });
      }
      if (gpxLayer && gpxLayer.eachLayer) {
        gpxLayer.eachLayer(function(l) {
          if (l.feature && l.feature.geometry && l.feature.geometry.coordinates) {
            const props = l.feature.properties || {};
            const coords = l.getLatLng();
            rows.push(['Park', props.name || '', coords.lat, coords.lng]);
          }
        });
      }
      let csv = rows.map(r => r.join(',')).join('\n');
      let blob = new Blob([csv], { type: 'text/csv' });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = 'assets.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    // Show reporting button after login
    function showReportingButton(show) {
      document.getElementById('reportingBtn').style.display = show ? 'block' : 'none';
    }
    const reportingBtn = document.getElementById('reportingBtn');
    if (reportingBtn) {
      reportingBtn.onclick = showReportingModal;
    }
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        showReportingButton(true);
      } else {
        showReportingButton(false);
      }
    });

    // SUMMARY MODAL
    let summaryModal = null;
    function showSummaryPopup() {
      if (!summaryModal) {
        summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));
      }
      loadGullySummary();
      summaryModal.show();
    }
    function loadGullySummary() {
      // Count gullies by status from KML and logs
      const statusCounts = {
        Clear: 0,
        Blocked: 0,
        Broken: 0,
        Remediation: 0,
        Replacement: 0,
        Unmarked: 0
      };
      if (kmlLayer && kmlLayer.eachLayer) {
        kmlLayer.eachLayer(function(l) {
          let status = 'Unmarked';
          if (l.feature && l.feature.properties && l.feature.properties.status) {
            status = l.feature.properties.status.trim();
          }
          if (!statusCounts[status]) status = 'Unmarked';
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
      }
      // Optionally, fetch latest status from logs in Firebase
      firebase.database().ref('/assetLogs').once('value', function(snapshot) {
        snapshot.forEach(assetSnap => {
          let latestStatus = null;
          let latestTime = 0;
          assetSnap.forEach(logSnap => {
            const log = logSnap.val();
            if (log.status && log.timestamp > latestTime) {
              latestStatus = log.status.trim();
              latestTime = log.timestamp;
            }
          });
          if (latestStatus && statusCounts[latestStatus] !== undefined) {
            statusCounts[latestStatus]++;
          }
        });
        // Render summary
        let html = '<ul class="list-group">';
        Object.keys(statusCounts).forEach(status => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">${status}<span class="badge bg-primary rounded-pill">${statusCounts[status]}</span></li>`;
        });
        html += '</ul>';
        document.getElementById('summaryBody').innerHTML = html;
      });
    }
    // Show summary button after login
    function showSummaryButton(show) {
      document.getElementById('summaryBtn').style.display = show ? 'block' : 'none';
    }
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        showSummaryButton(true);
      } else {
        showSummaryButton(false);
      }
    });
    const summaryBtn = document.getElementById('summaryBtn');
    if (summaryBtn) {
      summaryBtn.onclick = showSummaryPopup;
    }

    // AUDIT TRAIL LOGIC
    function logAuditTrail(action, details) {
      const user = getCurrentUserInfo();
      firebase.database().ref('/auditTrail').push({
        timestamp: Date.now(),
        user: user.email || 'unknown',
        role: user.role || 'unknown',
        action,
        details
      });
    }
    let auditTrailModal = null;
    function showAuditTrailModal() {
      if (!auditTrailModal) {
        auditTrailModal = new bootstrap.Modal(document.getElementById('auditTrailModal'));
      }
      loadAuditTrail();
      auditTrailModal.show();
    }
    function loadAuditTrail() {
      firebase.database().ref('/auditTrail').orderByChild('timestamp').limitToLast(100).once('value', function(snapshot) {
        const rows = [];
        snapshot.forEach(child => {
          const entry = child.val();
          rows.unshift(`<tr><td>${new Date(entry.timestamp).toLocaleString()}</td><td>${entry.user} (${entry.role})</td><td>${entry.action}</td><td>${entry.details}</td></tr>`);
        });
        document.getElementById('auditTrailTable').innerHTML = rows.join('');
      });
    }
    // Show/hide audit trail button for Admins only
    function showAuditTrailButton(show) {
      document.getElementById('auditTrailBtn').style.display = show ? 'block' : 'none';
    }
    const auditTrailBtn = document.getElementById('auditTrailBtn');
    if (auditTrailBtn) {
      auditTrailBtn.onclick = showAuditTrailModal;
    }
    firebase.auth().onAuthStateChanged(function(user) {
      if (user && window.currentUserRole === 'admin') {
        showAuditTrailButton(true);
      } else {
        showAuditTrailButton(false);
      }
    });
    // Hook audit logging into key actions
    // After successful login
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        logAuditTrail('Login', 'User logged in');
      }
    });
    // After adding asset log (in addAssetLog callback)
    // ...inside addAssetLog...
    if (!err) {
      logAuditTrail('Asset Log Added', `Asset: ${assetId}, Status: ${log.status}`);
      // ... existing code ...
    }
    // After creating/updating task (in newTaskForm and updateTaskStatus)
    // ...inside newTaskForm submit...
    if (!err) {
      logAuditTrail('Task Created', `Asset: ${assetId}, Assigned to: ${assignedTo}`);
      // ... existing code ...
    }
    // ...inside updateTaskStatus...
    if (!err) {
      logAuditTrail('Task Updated', `Task: ${taskId}, Status: ${status}`);
      // ... existing code ...
    }
  </script>
  <!-- Show/hide toolbar after login -->
  <script>
    function showToolbar(show) {
      document.getElementById('functionToolbar').style.display = show ? 'flex' : 'none';
    }
    // Show/hide login background image and overlay
    function showLoginBg(show) {
      document.getElementById('loginBg').style.display = show ? 'block' : 'none';
      document.getElementById('loginBgOverlay').style.display = show ? 'block' : 'none';
    }
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        showToolbar(true);
        updateUserInfoBar();
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('loginContainer').style.display = 'none';
        showLoginBg(false);
        // Hide asset filter bar if visible on login screen
        if (document.getElementById('assetFilterBar')) {
          document.getElementById('assetFilterBar').style.display = 'block';
        }
        // Force map resize in case it was hidden
        if (window.mapInstance && window.mapInstance.invalidateSize) {
          setTimeout(function() { window.mapInstance.invalidateSize(); }, 300);
        }
      } else {
        showToolbar(false);
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        showLoginBg(true);
      }
    });
    // Update user info bar
    function updateUserInfoBar() {
      const user = firebase.auth().currentUser;
      const role = window.currentUserRole || '';
      let name = '';
      if (user && user.uid) {
        firebase.database().ref('/users/' + user.uid).once('value').then(function(snapshot) {
          const data = snapshot.val();
          name = data && data.name ? data.name : (user.email || '');
          const approved = data && data.approved === false ? ' (Pending Approval)' : '';
          document.getElementById('userInfo').textContent = `${name} [${role}]${approved}`;
        });
      }
    }
    // Placeholder functions for toolbar buttons
    function showUserManagement() {
      loadAllUsers();
      new bootstrap.Modal(document.getElementById('usersModal')).show();
    }
    // Reset button logic with password confirmation
    function resetMap() {
      document.getElementById('resetConfirmMsg').textContent = '';
      document.getElementById('resetConfirmForm').reset();
      new bootstrap.Modal(document.getElementById('resetConfirmModal')).show();
    }
    const resetConfirmForm = document.getElementById('resetConfirmForm');
    if (resetConfirmForm) {
      resetConfirmForm.onsubmit = function(e) {
        e.preventDefault();
        const password = document.getElementById('resetPassword').value;
        const user = firebase.auth().currentUser;
        const email = user ? user.email : '';
        const msgDiv = document.getElementById('resetConfirmMsg');
        msgDiv.textContent = '';
        if (!user || !email) {
          msgDiv.innerHTML = '<span class="text-danger">User not found.</span>';
          return;
        }
        const cred = firebase.auth.EmailAuthProvider.credential(email, password);
        user.reauthenticateWithCredential(cred).then(function() {
          // Place your actual reset logic here
          msgDiv.innerHTML = '<span class="text-success">Reset confirmed. (Add your reset logic here.)</span>';
          setTimeout(() => { bootstrap.Modal.getInstance(document.getElementById('resetConfirmModal')).hide(); }, 1200);
        }).catch(function(error) {
          msgDiv.innerHTML = '<span class="text-danger">' + error.message + '</span>';
        });
      };
    }
    function showMapOptions() {
      new bootstrap.Modal(document.getElementById('mapsModal')).show();
    }
    function showLayerControl() {
      new bootstrap.Modal(document.getElementById('layersModal')).show();
    }
    function importData() { alert('Import not implemented yet.'); }
    function exportData() { alert('Export backup not implemented yet.'); }
    function enableEditMode() { alert('Edit mode not implemented yet.'); }
    function enableDeleteMode() { alert('Delete mode not implemented yet.'); }
    function enableAddMode() { alert('Add mode not implemented yet.'); }
  </script>
  <!-- Show/hide Reset button only for shane_dorgan@corkcity.ie -->
  <script>
    function updateResetButtonVisibility() {
      const user = firebase.auth().currentUser;
      const resetBtn = document.getElementById('resetBtn');
      if (resetBtn) {
        if (user && user.email && user.email.toLowerCase() === 'shane_dorgan@corkcity.ie') {
          resetBtn.style.display = 'inline-block';
        } else {
          resetBtn.style.display = 'none';
        }
      }
    }
    firebase.auth().onAuthStateChanged(function(user) {
      updateResetButtonVisibility();
    });
  </script>
  <!-- Layer toggle logic -->
  <script>
    function updateLayerVisibility() {
      if (typeof mapInstance === 'undefined') return;
      // Gullies
      if (document.getElementById('layerGullies').checked) {
        mapInstance.addLayer(kmlLayer);
      } else {
        mapInstance.removeLayer(kmlLayer);
      }
      // Parks/Playgrounds
      if (document.getElementById('layerParks').checked) {
        mapInstance.addLayer(gpxLayer);
      } else {
        mapInstance.removeLayer(gpxLayer);
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('layersForm')) {
        document.getElementById('layersForm').addEventListener('change', updateLayerVisibility);
      }
    });
  </script>
  <!-- Basemap switching logic -->
  <script>
    let streetLayer = null;
    let satelliteLayer = null;
    function setBasemap(type) {
      if (!mapInstance) return;
      if (!streetLayer) {
        streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© OpenStreetMap contributors'
        });
      }
      if (!satelliteLayer) {
        satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 19,
          attribution: 'Tiles Â© Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });
      }
      if (type === 'satellite') {
        if (mapInstance.hasLayer(streetLayer)) mapInstance.removeLayer(streetLayer);
        if (!mapInstance.hasLayer(satelliteLayer)) mapInstance.addLayer(satelliteLayer);
      } else {
        if (mapInstance.hasLayer(satelliteLayer)) mapInstance.removeLayer(satelliteLayer);
        if (!mapInstance.hasLayer(streetLayer)) mapInstance.addLayer(streetLayer);
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      // Set up basemap switching
      if (document.getElementById('mapsForm')) {
        document.getElementById('mapsForm').addEventListener('change', function(e) {
          if (e.target.name === 'basemap') {
            setBasemap(e.target.value);
          }
        });
      }
      // Ensure default basemap is street
      setTimeout(function() { setBasemap('street'); }, 500);
    });
  </script>
  <!-- User management modal logic -->
  <script>
    function loadAllUsers() {
      const usersTable = document.getElementById('usersTable');
      usersTable.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      firebase.database().ref('/users').once('value', function(snapshot) {
        const users = [];
        snapshot.forEach(child => {
          const u = child.val();
          u._uid = child.key;
          users.push(u);
        });
        // Try to get last login from localStorage (if available)
        users.forEach(u => {
          u.lastLogin = localStorage.getItem('lastLogin_' + u.email) || '';
        });
        usersTable.innerHTML = users.map(u => `<tr><td>${u.name || ''}</td><td>${u.email || ''}</td><td>${u.role || ''}</td><td>${u.lastLogin}</td></tr>`).join('');
      });
    }
    // Store last login time for current user
    firebase.auth().onAuthStateChanged(function(user) {
      if (user && user.email) {
        localStorage.setItem('lastLogin_' + user.email, new Date().toLocaleString());
      }
    });
  </script>
  <!-- Show/hide Users button for Admins only -->
  <script>
    function showUsersButton(show) {
      document.getElementById('usersBtn').style.display = show ? 'inline-block' : 'none';
    }
    const usersBtn = document.getElementById('usersBtn');
    if (usersBtn) {
      usersBtn.onclick = showUserManagement;
    }
    firebase.auth().onAuthStateChanged(function(user) {
      if (user && window.currentUserRole === 'admin') {
        showUsersButton(true);
      } else {
        showUsersButton(false);
      }
    });
  </script>
  <!-- Show/hide password toggle -->
  <script>
    const passwordInput = document.getElementById('password');
    const togglePasswordBtn = document.getElementById('togglePassword');
    const togglePasswordIcon = document.getElementById('togglePasswordIcon');
    if (togglePasswordBtn && passwordInput && togglePasswordIcon) {
      togglePasswordBtn.onclick = function(e) {
        e.preventDefault();
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          togglePasswordIcon.classList.remove('bi-eye');
          togglePasswordIcon.classList.add('bi-eye-slash');
        } else {
          passwordInput.type = 'password';
          togglePasswordIcon.classList.remove('bi-eye-slash');
          togglePasswordIcon.classList.add('bi-eye');
        }
      };
    }
  </script>
  <!-- Inactivity timeout (10 minutes) -->
  <script>
    let inactivityTimeout = null;
    let inactivityWarningShown = false;
    function resetInactivityTimer() {
      if (inactivityTimeout) clearTimeout(inactivityTimeout);
      if (!firebase.auth().currentUser) return;
      inactivityTimeout = setTimeout(function() {
        inactivityWarningShown = true;
        firebase.auth().signOut();
        setTimeout(function() {
          const loginError = document.getElementById('loginError');
          if (loginError) {
            loginError.innerHTML = '<span class="text-danger">You have been logged out due to inactivity.</span>';
          }
        }, 500);
      }, 10 * 60 * 1000); // 10 minutes
    }
    function setupInactivityListeners() {
      ['mousemove','keydown','mousedown','touchstart','scroll'].forEach(evt => {
        window.addEventListener(evt, resetInactivityTimer, true);
      });
    }
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        resetInactivityTimer();
        setupInactivityListeners();
        inactivityWarningShown = false;
      } else {
        if (inactivityTimeout) clearTimeout(inactivityTimeout);
        if (!inactivityWarningShown) {
          const loginError = document.getElementById('loginError');
          if (loginError) loginError.textContent = '';
        }
      }
    });
  </script>
</body>
</html>