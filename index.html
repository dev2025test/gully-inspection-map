<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gully Inspection System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; display: none; }
    #loginScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3); text-align: center;
    }
    #controlPanel, #summary {
      position: absolute; background: white; padding: 10px;
      border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,0.3); z-index: 999;
    }
    #controlPanel { bottom: 10px; left: 10px; display: none; }
    #summary { top: 10px; right: 10px; font-size: 0.9em; display: none; }
    .dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #000; }
    .popup-form input, .popup-form select, .popup-form textarea { width: 100%; margin-bottom: 6px; }
    .inspection-popup .leaflet-popup-content {
      margin: 5px;
      width: auto !important;
    }
    .popup-form input[type="text"],
    .popup-form input[type="date"],
    .popup-form select,
    .popup-form textarea {
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .popup-form button {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .popup-form button:hover {
      background: #e0e0e0;
    }
    .popup-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .layer-control {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      margin-left: 10px;
      margin-top: 10px;
    }
    .layer-control select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .layer-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .layer-content.expanded {
      max-height: 500px;
    }
    .layer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 5px;
      background: #f5f5f5;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .layer-header:hover {
      background: #e0e0e0;
    }
    .collapse-icon {
      transition: transform 0.3s ease;
    }
    .collapse-icon.expanded {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
<div id="roleBanner" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);
background:#eee;padding:8px 20px;border-radius:6px;box-shadow:0 0 4px rgba(0,0,0,0.3);z-index:1001;
font-weight:bold;"></div>

<div id="loginScreen">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<div id="map"></div>

<div id="controlPanel">
  <label for="importFile" style="background:#ddd;padding:6px 12px;border-radius:4px;cursor:pointer;">üóÇÔ∏è Import</label>
  <input type="file" id="importFile" accept=".kml" style="display:none;">
  <span id="fileNameDisplay" style="margin-left:10px;font-style:italic;color:#555;"></span>
  
  <button onclick="exportData()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;margin-left:5px;">üíæ Export CSV</button>
  <button onclick="resetMap()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">‚ôªÔ∏è Reset</button>
  <button onclick="saveGullyData()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üíæ Backup JSON</button>
  <button onclick="enableDeleteMode()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üóëÔ∏è Delete Gully</button>
  <button onclick="enableEditMode()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">‚úèÔ∏è Edit Gully</button>
  <button onclick="logout()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;margin-left:5px;">üö™ Logout</button>
  
  <div style="margin-top:10px;display:flex;gap:5px;align-items:center;">
    <button onclick="toggleLayerPanel()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üó∫Ô∏è Layers</button>
    <select id="activeLayer" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;cursor:pointer;">
      <option value="gullies">üîµ Gullies</option>
      <option value="signage">üö∏ Signage</option>
      <option value="playgrounds">üéÆ Playgrounds</option>
      <option value="parks">üå≥ Parks</option>
      <option value="walkways">üö∂ Walkways</option>
      <option value="lining">üé® Lining</option>
    </select>
  </div>

  <div id="layerPanel" style="display:none;margin-top:5px;background:#f8f8f8;padding:8px;border-radius:4px;border:1px solid #ddd;">
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:5px;">
      <button class="layer-toggle" data-layer="gullies" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:blue;">‚¨§</span> Gullies
      </button>
      <button class="layer-toggle" data-layer="signage" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:orange;">‚¨§</span> Signage
      </button>
      <button class="layer-toggle" data-layer="playgrounds" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:green;">‚¨§</span> Playgrounds
      </button>
      <button class="layer-toggle" data-layer="parks" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:darkgreen;">‚¨§</span> Parks
      </button>
      <button class="layer-toggle" data-layer="walkways" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:purple;">‚¨§</span> Walkways
      </button>
      <button class="layer-toggle" data-layer="lining" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;text-align:left;">
        <span style="color:red;">‚¨§</span> Lining
      </button>
    </div>
  </div>
</div>

<div id="summary">
  <b>Summary</b><br>
  <div id="summaryContent"></div>
  <label>Filter:</label>
  <select id="filterStatus" onchange="filterByStatus()">
    <option value="All">All</option>
    <option value="Clear">Clear</option>
    <option value="Broken">Broken</option>
    <option value="Remediation">Remediation</option>
    <option value="Replacement">Replacement</option>
    <option value="Blocked">Blocked</option>
    <option value="Expired">Expired</option>
  </select>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBsteq-tHQdiDcRk5UBg52AwAxpVcq67cw",
  authDomain: "gullytest3.firebaseapp.com",
  databaseURL: "https://gullytest3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gullytest3",
  storageBucket: "gullytest3.appspot.com",
  messagingSenderId: "876083677912",
  appId: "1:876083677912:web:065de0c7cca446b78f65ad"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let currentRole = null;
let map;
const importedFiles = new Set();
const gullyData = [];
let deleteMode = false;
let currentMarker = null;
let editMode = false;
let currentActiveLayer = 'gullies';
let currentInspectionPopup = null;
let inactivityTimer = null;
const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds

// Add layer groups
let layers = {
  gullies: L.layerGroup(),
  signage: L.layerGroup(),
  playgrounds: L.layerGroup(),
  parks: L.layerGroup(),
  walkways: L.layerGroup(),
  lining: L.layerGroup()
};

// Add layer names for UI
const layerNames = {
  gullies: "Gullies",
  signage: "Signage",
  playgrounds: "Playgrounds",
  parks: "Parks",
  walkways: "Walkways",
  lining: "Lining"
};

function resetInactivityTimer() {
  // Clear existing timer
  if (inactivityTimer) {
    clearTimeout(inactivityTimer);
  }
  
  // Set new timer
  inactivityTimer = setTimeout(() => {
    if (auth.currentUser) {
      alert('You have been logged out due to inactivity.');
      logout();
    }
  }, INACTIVITY_TIMEOUT);
}

function setupInactivityTracking() {
  // Track mouse movement
  document.addEventListener('mousemove', resetInactivityTimer);
  
  // Track clicks
  document.addEventListener('click', resetInactivityTimer);
  
  // Track keyboard activity
  document.addEventListener('keydown', resetInactivityTimer);
  
  // Track scroll events
  document.addEventListener('scroll', resetInactivityTimer);
  
  // Track map interactions
  map.on('drag', resetInactivityTimer);
  map.on('zoom', resetInactivityTimer);
  map.on('click', resetInactivityTimer);
  
  // Track form interactions
  document.addEventListener('input', resetInactivityTimer);
  
  // Start initial timer
  resetInactivityTimer();
}

// Add helper function for login validation
function normalizeEmail(email) {
  if (!email) return '';
  email = email.toLowerCase().trim();
  
  // Handle common variations
  const emailMap = {
    'aman_kushwaha@corkcity.ie': 'aman_kushwaha@corkcity.ie', // Keep underscore format
    'aman.kushwaha@corkcity.ie': 'aman_kushwaha@corkcity.ie',
    'ronan_oconnor@corkcity.ie': 'ronan_oconnor@corkcity.ie', // Keep underscore format
    'ronan.oconnor@corkcity.ie': 'ronan_oconnor@corkcity.ie'
  };
  
  return emailMap[email] || email;
}

function login() {
  let email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  
  if (!email || !password) {
    document.getElementById("loginError").textContent = "‚ùå Please enter both email and password";
    return;
  }

  // Normalize email before login
  email = normalizeEmail(email);
  
  document.getElementById("loginError").textContent = "Logging in...";
  
  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      const uid = userCredential.user.uid;
      console.log('User logged in:', uid);
      
      // Check if user exists in users collection
      return db.ref("users/" + uid).once("value").then(snapshot => {
        if (!snapshot.exists()) {
          console.log('Creating new user with default role');
          // Set role based on email
          let role = 'operator'; // default role
          if (email.toLowerCase() === 'aman_kushwaha@corkcity.ie') {
            role = 'admin';
          }
          return db.ref("users/" + uid).set({
            email: email,
            role: role,
            created: firebase.database.ServerValue.TIMESTAMP
          }).then(() => {
            return db.ref("users/" + uid).once("value");
          });
        } else {
          // Update existing user's role if needed
          const userData = snapshot.val();
          if (email.toLowerCase() === 'aman_kushwaha@corkcity.ie' && userData.role !== 'admin') {
            return db.ref("users/" + uid).update({
              role: 'admin'
            }).then(() => {
              return db.ref("users/" + uid).once("value");
            });
          } else if (email.toLowerCase() === 'ronan_oconnor@corkcity.ie' && userData.role !== 'operator') {
            return db.ref("users/" + uid).update({
              role: 'operator'
            }).then(() => {
              return db.ref("users/" + uid).once("value");
            });
          }
          console.log('Existing user data:', snapshot.val());
          return snapshot;
        }
      });
    })
    .then(snapshot => {
      if (!snapshot.exists()) {
        throw new Error('User data not found');
      }
      
      const userData = snapshot.val();
      if (!userData.role) {
        throw new Error('User role not set');
      }
      
      currentRole = userData.role;
      console.log('Current user role:', currentRole);
      
      // Show role and initials in banner
      let inspectorName = auth.currentUser.email;
      let inspectorInitials = "UN";
      
      switch (auth.currentUser.email.toLowerCase()) {
        case 'richard_daly@corkcity.ie':
          inspectorName = "Richard Daly";
          inspectorInitials = "RD";
          break;
        case 'john_ocallaghan@corkcity.ie':
          inspectorName = "John O'Callaghan";
          inspectorInitials = "JO";
          break;
        case 'shane_dorgan@corkcity.ie':
          inspectorName = "Shane Dorgan";
          inspectorInitials = "SD";
          break;
        case 'ronan_oconnor@corkcity.ie':
          inspectorName = "Ronan O'Connor";
          inspectorInitials = "RO";
          break;
        case 'aman_kushwaha@corkcity.ie':
          inspectorName = "Aman Kushwaha";
          inspectorInitials = "AK";
          break;
        default:
          inspectorName = auth.currentUser.email;
          inspectorInitials = userData.initials || auth.currentUser.email.substring(0, 2).toUpperCase();
      }
      
      document.getElementById("roleBanner").innerText = `Logged in as: ${currentRole.toUpperCase()} (${inspectorInitials})`;
      
      // Store user data globally
      window.currentUserData = userData;
      
      // Setup UI based on role
      setupUIForRole(currentRole);
      
      // Initialize map and load data
      document.getElementById("loginScreen").style.display = 'none';
      document.getElementById("map").style.display = 'block';
      document.getElementById("controlPanel").style.display = 'block';
      document.getElementById("summary").style.display = 'block';

      initMap();
      loadGullyData();
      
      // Start inactivity tracking after successful login
      setupInactivityTracking();
    })
    .catch(error => {
      console.error('Login error:', error);
      let errorMessage = "‚ùå ";
      
      switch (error.code) {
        case 'auth/user-not-found':
          errorMessage += "No account found with this email";
          break;
        case 'auth/wrong-password':
          errorMessage += "Incorrect password";
          break;
        case 'auth/invalid-email':
          errorMessage += "Invalid email format";
          break;
        case 'auth/user-disabled':
          errorMessage += "This account has been disabled";
          break;
        case 'auth/operation-not-allowed':
          errorMessage += "Email/Password sign-in is not enabled. Please contact administrator";
          break;
        default:
          errorMessage += error.message;
      }
      
      document.getElementById("loginError").textContent = errorMessage;
    });
}

function setupUIForRole(role) {
  const isAdmin = role === 'admin';
  const isOperator = role === 'operator';
  
  // Allow operators to save inspections and view history
  document.getElementById("importFile").disabled = !isAdmin;
  document.querySelectorAll("#controlPanel button").forEach(btn => {
    if (btn.innerText.includes('Logout')) return;
    if (btn.innerText.includes('Export CSV') || btn.innerText.includes('Backup JSON')) {
      btn.disabled = !isAdmin && !isOperator;
    } else {
      btn.disabled = !isAdmin;
    }
    btn.style.opacity = btn.disabled ? 0.5 : 1;
  });
}

function initMap() {
  // Add custom CSS to ensure markers are always on top
  const customCSS = `
    .gully-marker {
      z-index: 1000 !important;
    }
    .dot {
      z-index: 1000 !important;
      opacity: 1 !important;
    }
    .leaflet-marker-icon {
      z-index: 1000 !important;
    }
    .leaflet-marker-pane {
      z-index: 600 !important;
    }
    .leaflet-popup-pane {
      z-index: 700 !important;
    }
  `;
  const style = document.createElement('style');
  style.textContent = customCSS;
  document.head.appendChild(style);

  map = L.map('map', {
    preferCanvas: false,
    zoomControl: true,
    maxZoom: 19
  }).setView([51.9, -8.5], 13);
  
  // Add tile layer with explicit z-index
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    zIndex: 100
  }).addTo(map);
  
  // Add scale control
  L.control.scale().addTo(map);

  // Add all layers to map
  Object.values(layers).forEach(layer => layer.addTo(map));
  
  initLayerToggles();
  
  document.getElementById('importFile').addEventListener('change', handleKMLImport);
}

function initLayerToggles() {
  // Add click handlers for layer toggle buttons
  document.querySelectorAll('.layer-toggle').forEach(button => {
    const layerName = button.dataset.layer;
    
    // Update the icon in the button
    const icon = button.querySelector('span');
    if (layerName === 'playgrounds' || layerName === 'parks') {
      icon.innerHTML = '‚ñ≤'; // Triangle symbol
      icon.style.fontSize = '12px';
    }
    
    button.addEventListener('click', () => {
      const isActive = button.classList.toggle('active');
      button.style.background = isActive ? '#e0e0e0' : '#f0f0f0';
      if (isActive) {
        layers[layerName].addTo(map);
      } else {
        map.removeLayer(layers[layerName]);
      }
    });
    // Start with all layers active
    button.classList.add('active');
    button.style.background = '#e0e0e0';
  });

  // Add change handler for active layer dropdown
  document.getElementById('activeLayer').addEventListener('change', (e) => {
    currentActiveLayer = e.target.value;
  });
}

function createDot(color) {
  return L.divIcon({
    className: 'gully-marker',
    html: `<div class='dot' style='background:${color};width:20px;height:20px;border-radius:50%;border:3px solid black;box-shadow:0 0 4px white, 0 0 6px black;'></div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12]
  });
}

function createTriangle(color) {
  return L.divIcon({
    className: 'triangle-marker',
    html: `<div style='width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:20px solid ${color};filter:drop-shadow(0 0 2px black);'></div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 20],
    popupAnchor: [0, -20]
  });
}

function getMarkerIcon(layerType, status = 'Unmarked') {
  const color = getStatusColor(status);
  
  switch(layerType) {
    case 'playgrounds':
    case 'parks':
      return createTriangle(color);
    default:
      return new L.DivIcon({
        className: 'custom-div-icon',
        html: `<div style='background-color:${color};width:15px;height:15px;border-radius:50%;border:2px solid black'></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
  }
}

function addGullyToMap(latlng, gullyId, layerType = 'gullies') {
  console.log('Adding marker to layer:', layerType);
  
  const marker = new L.Marker([latlng.lat, latlng.lng], {
    icon: getMarkerIcon(layerType)
  });
  
  // Add marker to appropriate layer
  if (layers[layerType]) {
    layers[layerType].addLayer(marker);
  } else {
    console.warn('Unknown layer type:', layerType);
    layers.gullies.addLayer(marker);
  }
  
  marker.on('click', () => {
    if (deleteMode) {
      handleGullyDelete(gullyId, marker, layerType);
    } else {
      currentMarker = marker;
      showInspectionPopup(marker, gullyId, latlng, layerType);
    }
  });
  
  marker.setZIndexOffset(1000);
  
  gullyData.push({ marker, id: gullyId, layer: layerType });
  return marker;
}

function handleKMLImport(event) {
  if (currentRole !== 'admin') {
    alert('Only administrators can import KML files');
    return;
  }

  const file = event.target.files[0];
  if (importedFiles.has(file.name)) {
    alert("This file has already been imported.");
    return;
  }
  
  importedFiles.add(file.name);
  const reader = new FileReader();
  
  reader.onload = async () => {
    try {
      console.log('File read successfully, parsing KML...');
      const kml = new DOMParser().parseFromString(reader.result, 'text/xml');
      const geojson = toGeoJSON.kml(kml);
      
      if (!geojson.features || geojson.features.length === 0) {
        alert('No valid points found in KML file');
        return;
      }

      console.log(`Found ${geojson.features.length} features in KML`);

      let pointsAdded = 0;
      let bounds = L.latLngBounds([]);
      let markers = [];
      
      // Process points
      for (const f of geojson.features) {
        if (f.geometry && f.geometry.type === 'Point' && f.geometry.coordinates) {
          const [lng, lat] = f.geometry.coordinates;
          
          if (isValidCoordinate(lng, lat)) {
            const itemId = `${currentActiveLayer}_${Date.now()}_${pointsAdded}`;
            
            try {
              // Create marker with current layer type
              const marker = new L.Marker([lat, lng], {
                icon: new L.DivIcon({
                  className: 'custom-div-icon',
                  html: "<div style='background-color:#808080;width:15px;height:15px;border-radius:50%;border:2px solid black'></div>",
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                })
              });
              
              // Add to appropriate layer
              layers[currentActiveLayer].addLayer(marker);
              
              // Set up click handler
              marker.on('click', () => {
                if (deleteMode) {
                  handleGullyDelete(itemId, marker, currentActiveLayer);
                } else {
                  showInspectionPopup(marker, itemId, { lat, lng }, currentActiveLayer);
                }
              });
              
              markers.push(marker);
              gullyData.push({ marker, id: itemId, layer: currentActiveLayer });
              bounds.extend([lat, lng]);
              pointsAdded++;
              
              // Save to Firebase under the current layer
              await db.ref(`${currentActiveLayer}/${itemId}`).set({
                location: { lat, lng },
                created: firebase.database.ServerValue.TIMESTAMP,
                createdBy: auth.currentUser.uid,
                status: 'Unmarked'
              });
              
            } catch (err) {
              console.error('Error creating marker:', err);
            }
          }
        }
      }
      
      if (pointsAdded > 0) {
        const paddedBounds = bounds.pad(0.2);
        map.fitBounds(paddedBounds);
        
        markers.forEach(marker => {
          if (marker) {
            marker.setZIndexOffset(1000);
          }
        });
        
        updateSummary();
        alert(`Successfully imported ${pointsAdded} points to ${layerNames[currentActiveLayer]} layer`);
      } else {
        alert('No valid points found in the KML file');
      }
    } catch (error) {
      console.error('Error in KML import:', error);
      alert('Error importing KML file: ' + error.message);
    }
  };
  
  reader.onerror = (error) => {
    console.error('Error reading file:', error);
    alert('Error reading file: ' + error.message);
  };
  
  reader.readAsText(file);
}

function isValidCoordinate(lng, lat) {
  return !isNaN(lng) && !isNaN(lat) && 
         lng >= -180 && lng <= 180 && 
         lat >= -90 && lat <= 90;
}

function showInspectionPopup(marker, gullyId, latlng, layerType) {
  // Close any existing popup first
  if (currentInspectionPopup) {
    map.closePopup(currentInspectionPopup);
  }

  const popupContent = document.createElement('div');
  popupContent.className = 'popup-form';
  popupContent.style.padding = '10px';

  // Create form HTML with proper event handling
  popupContent.innerHTML = `
    <div style="margin-bottom: 10px;">
      <label>
        <input type="checkbox" id="inspection-complete" style="margin-right: 5px;">
        Inspection Complete
      </label>
    </div>
    
    <div style="margin-bottom: 10px;">
      <label>Date:</label>
      <input type="date" id="inspection-date" 
        value="${new Date().toISOString().split('T')[0]}" 
        max="${new Date().toISOString().split('T')[0]}"
        style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 10px;">
      <label>Status:</label>
      <select id="inspection-status" style="width: 100%;">
        ${getStatusOptionsForLayer(layerType)}
      </select>
    </div>

    <div style="margin-bottom: 10px;">
      <label>Comments:</label>
      <textarea id="inspection-comment" placeholder="Add inspection comments..." style="width: 100%; height: 60px;"></textarea>
    </div>
    
    <div style="margin-bottom: 10px;">
      <label>Photo:</label>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <input type="file" id="inspection-photo" accept="image/*" style="width: 100%;">
        <button onclick="capturePhoto()" style="background: #2196F3; color: white; border: none; padding: 8px; border-radius: 4px; width: 100%;">
          üì∏ Take Picture
        </button>
      </div>
    </div>
    
    <div style="margin-top: 15px; display: flex; justify-content: space-between;">
      <button id="save-inspection-btn" style="flex: 1; margin-right: 10px; background: #4CAF50; color: white; border: none; padding: 8px; border-radius: 4px;">
        üíæ Save Inspection
      </button>
      <button onclick="viewGullyHistory('${gullyId}')" style="flex: 1; background: #2196F3; color: white; border: none; padding: 8px; border-radius: 4px;">
        üìã View History
      </button>
    </div>
  `;

  // Create popup
  const popup = L.popup({
    maxWidth: 300,
    className: 'inspection-popup',
    closeButton: true,
    autoClose: false,
    closeOnClick: false
  })
  .setLatLng(latlng)
  .setContent(popupContent);

  currentInspectionPopup = popup;
  marker.bindPopup(popup).openPopup();

  // Add event listener after the popup is added to DOM
  setTimeout(() => {
    const saveButton = document.getElementById('save-inspection-btn');
    if (saveButton) {
      saveButton.addEventListener('click', () => {
        saveInspection(gullyId, marker, layerType);
      });
    }
  }, 100);
}

function getStatusOptionsForLayer(layerType) {
  const options = {
    gullies: ['Clear', 'Blocked', 'Broken', 'Remediation', 'Replacement'],
    signage: ['Good', 'Damaged', 'Missing'],
    playgrounds: ['Operational', 'Needs Repair', 'Out of Service'],
    parks: ['Open', 'Under Maintenance', 'Closed'],
    walkways: ['Clear', 'Obstructed', 'Under Repair'],
    lining: ['Good', 'Faded', 'Needs Repainting']
  };

  return (options[layerType] || []).map(status => 
    `<option value="${status}">${status}</option>`
  ).join('');
}

async function saveInspection(gullyId, marker, layerType) {
  if (!auth.currentUser) {
    alert('You must be logged in to save inspections');
    return;
  }

  const formData = {
    complete: document.getElementById('inspection-complete').checked,
    date: document.getElementById('inspection-date').value,
    status: document.getElementById('inspection-status').value,
    comment: document.getElementById('inspection-comment').value,
    location: marker.getLatLng()
  };

  if (!formData.complete) {
    alert('Please mark inspection as complete');
    return;
  }

  try {
    // Get current user data
    const userData = window.currentUserData;
    if (!userData) {
      throw new Error('User data not found. Please log out and log in again.');
    }

    // Get inspector full name based on email
    let inspectorName = "Unknown";
    let inspectorInitials = "UN";
    
    switch (auth.currentUser.email.toLowerCase()) {
      case 'richard_daly@corkcity.ie':
        inspectorName = "Richard Daly";
        inspectorInitials = "RD";
        break;
      case 'john_ocallaghan@corkcity.ie':
        inspectorName = "John O'Callaghan";
        inspectorInitials = "JO";
        break;
      case 'shane_dorgan@corkcity.ie':
        inspectorName = "Shane Dorgan";
        inspectorInitials = "SD";
        break;
      case 'ronan_oconnor@corkcity.ie':
      case 'ronan.oconnor@corkcity.ie':  // Add alternative email format
        inspectorName = "Ronan O'Connor";
        inspectorInitials = "RO";
        break;
      case 'aman_kushawaha@corkcity.ie':
      case 'aman.kushawaha@corkcity.ie':  // Add alternative email format
      case 'aman_kushwaha@corkcity.ie':   // Add common spelling variation
      case 'aman.kushwaha@corkcity.ie':   // Add common spelling variation
        inspectorName = "Aman Kushwaha";
        inspectorInitials = "AK";
        break;
      default:
        inspectorName = auth.currentUser.email;
        inspectorInitials = userData.initials || auth.currentUser.email.substring(0, 2).toUpperCase();
    }

    // Create basic inspection data
    const timestamp = Date.now();
    const inspectionData = {
      date: formData.date,
      status: formData.status,
      comment: formData.comment,
      complete: formData.complete,
      timestamp: timestamp,
      inspector: {
        name: inspectorName,
        email: auth.currentUser.email,
        uid: auth.currentUser.uid,
        role: userData.role,
        initials: inspectorInitials
      }
    };

    // Handle photo upload if present
    const photoFile = document.getElementById('inspection-photo').files[0];
    if (photoFile) {
      try {
        const photoRef = storage.ref(`photos/${gullyId}/${timestamp}_${photoFile.name}`);
        await photoRef.put(photoFile);
        inspectionData.photoURL = await photoRef.getDownloadURL();
      } catch (error) {
        console.error('Photo upload failed:', error);
        alert('Warning: Photo upload failed, but inspection will still be saved.');
      }
    }

    // Save the inspection
    const gullyRef = db.ref(`gullies/${gullyId}`);
    
    // Update gully data - using timestamp as key for unique inspections
    const updates = {
      [`inspections/${timestamp}`]: inspectionData,
      status: formData.status,
      lastInspection: timestamp,
      lastInspector: inspectionData.inspector
    };

    await gullyRef.update(updates);

    // Also save to history collection
    await db.ref(`gully_history/${gullyId}/${timestamp}`).set(inspectionData);

    // Update marker and UI
    updateMarkerStatus(marker, formData.status, layerType);
    updateSummary();
    
    // Show success message
    alert('Inspection saved successfully');
    
    // Clear form but keep popup open for potential new inspection
    document.getElementById('inspection-complete').checked = false;
    document.getElementById('inspection-comment').value = '';
    document.getElementById('inspection-photo').value = '';
    
    // Keep the popup open for another potential inspection
    showInspectionPopup(marker, gullyId, formData.location, layerType);

  } catch (error) {
    console.error('Save inspection error:', error);
    alert('Error saving inspection: ' + error.message);
  }
}

function capturePhoto() {
  try {
    const photoInput = document.getElementById('inspection-photo');
    // Create a temporary input for capturing photos
    const tempInput = document.createElement('input');
    tempInput.type = 'file';
    tempInput.accept = 'image/*';
    tempInput.capture = 'environment'; // Use the back camera
    
    // When a photo is selected, copy it to the main photo input
    tempInput.onchange = function() {
      if (this.files && this.files[0]) {
        photoInput.files = this.files;
      }
    };
    
    tempInput.click();
  } catch (error) {
    console.error('Error capturing photo:', error);
    alert('Error capturing photo. Please try again.');
  }
}

function updateMarkerStatus(marker, status, layerType = 'gullies') {
  marker.setIcon(getMarkerIcon(layerType, status));
}

async function viewGullyHistory(gullyId) {
  try {
    // Get history from both locations
    const [inspectionsSnapshot, historySnapshot] = await Promise.all([
      db.ref(`gullies/${gullyId}/inspections`).once('value'),
      db.ref(`gully_history/${gullyId}`).once('value')
    ]);
    
    // Combine and sort all inspections
    const allInspections = [];
    
    // Add inspections from main gully record
    if (inspectionsSnapshot.exists()) {
      Object.values(inspectionsSnapshot.val()).forEach(inspection => {
        allInspections.push(inspection);
      });
    }
    
    // Add inspections from history
    if (historySnapshot.exists()) {
      Object.values(historySnapshot.val()).forEach(inspection => {
        allInspections.push(inspection);
      });
    }
    
    // Sort by timestamp, most recent first
    allInspections.sort((a, b) => b.timestamp - a.timestamp);
    
    // Create history display
    const historyHtml = allInspections.map(inspection => {
      const date = new Date(inspection.timestamp).toLocaleString();
      const inspectorInfo = inspection.inspector || {};
      const inspectorName = inspectorInfo.name || 'Unknown';
      const inspectorInitials = inspectorInfo.initials || 'UN';
      const status = inspection.status || 'Unknown';
      const photoHtml = inspection.photoURL ? 
        `<br><a href="${inspection.photoURL}" target="_blank" style="color: blue;">üì∑ View Photo</a>` : '';
      
      return `
        <div style="border-bottom: 1px solid #ccc; margin-bottom: 10px; padding-bottom: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <strong style="font-size: 1.1em;">${date}</strong>
            <div>
              <span style="background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-weight: bold;">${inspectorInitials}</span>
            </div>
          </div>
          <div style="margin: 5px 0;">
            <span style="font-weight: bold;">Inspector:</span> ${inspectorName}
          </div>
          <div style="margin: 5px 0;">
            <span style="font-weight: bold;">Status:</span> 
            <span style="color: ${getStatusColor(status)};">${status}</span>
          </div>
          <div style="margin: 5px 0;">
            <span style="font-weight: bold;">Comments:</span><br>
            ${inspection.comment || 'None'}
          </div>
          ${photoHtml}
        </div>
      `;
    }).join('');
    
    // Create and show modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 10000;
    `;
    
    modal.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Inspection History</h3>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="border: none; background: #f0f0f0; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
          ‚úñ Close
        </button>
      </div>
      <div>${historyHtml || 'No inspection history available'}</div>
    `;
    
    document.body.appendChild(modal);
    
  } catch (error) {
    console.error('Error loading history:', error);
    alert('Error loading history: ' + error.message);
  }
}

function loadGullyData() {
  Object.keys(layers).forEach(layerType => {
    db.ref(layerType).on('value', snapshot => {
      const data = snapshot.val() || {};
      const existingIds = new Set(gullyData.filter(g => g.layer === layerType).map(g => g.id));
      
      Object.entries(data).forEach(([id, item]) => {
        if (!existingIds.has(id)) {
          console.log(`Loading ${layerType} item from Firebase:`, id);
          
          const status = item.status || 'Unmarked';
          const color = getStatusColor(status);
          
          const marker = new L.Marker(item.location, {
            icon: new L.DivIcon({
              className: 'custom-div-icon',
              html: `<div style='background-color:${color};width:15px;height:15px;border-radius:50%;border:2px solid black'></div>`,
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            })
          });
          
          layers[layerType].addLayer(marker);
          marker.setZIndexOffset(1000);
          
          marker.on('click', () => {
            if (deleteMode) {
              handleGullyDelete(id, marker, layerType);
            } else {
              showInspectionPopup(marker, id, item.location, layerType);
            }
          });
          
          gullyData.push({ marker, id, layer: layerType });
        }
      });
      
      updateSummary();
    });
  });
}

function getStatusColor(status) {
  const colors = {
    Clear: '#0000FF', // Blue
    Blocked: '#FFA500', // Orange
    Broken: '#FF0000', // Red
    Remediation: '#800080', // Purple
    Replacement: '#FFFF00', // Yellow
    Expired: '#808080', // Gray
    Unmarked: '#808080' // Gray
  };
  return colors[status] || '#808080';
}

function updateSummary() {
  // For gullies, maintain the original detailed summary
  const gullyCounts = {
    Clear: 0,
    Blocked: 0,
    Broken: 0,
    Remediation: 0,
    Replacement: 0,
    Expired: 0,
    Unmarked: 0
  };

  let totalGullies = 0;
  
  gullyData.forEach(({ id, layer }) => {
    if (layer === 'gullies') {
      totalGullies++;
      db.ref(`gullies/${id}/inspections`).orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
        const lastInspection = Object.values(snapshot.val() || {})[0];
        if (!lastInspection) {
          gullyCounts.Unmarked++;
        } else {
          const ageMonths = (Date.now() - lastInspection.timestamp) / (1000 * 60 * 60 * 24 * 30.5);
          if (ageMonths > 12) {
            gullyCounts.Expired++;
          } else {
            gullyCounts[lastInspection.status]++;
          }
        }
        
        // Update the summary display with only gully information
        document.getElementById("summaryContent").innerHTML = `
          <strong>Gullies</strong> (${totalGullies})<br>
          <span style='color:blue;'>‚¨§</span> Clear: ${gullyCounts.Clear}<br>
          <span style='color:orange;'>‚¨§</span> Blocked: ${gullyCounts.Blocked}<br>
          <span style='color:red;'>‚¨§</span> Broken: ${gullyCounts.Broken}<br>
          <span style='color:purple;'>‚¨§</span> Remediation: ${gullyCounts.Remediation}<br>
          <span style='color:yellow;'>‚¨§</span> Replacement: ${gullyCounts.Replacement}<br>
          <span style='color:gray;'>‚¨§</span> Expired: ${gullyCounts.Expired}<br>
          <span style='color:lightgray;'>‚¨§</span> Unmarked: ${gullyCounts.Unmarked}
        `;
      });
    }
  });
}

function filterByStatus() {
  const selected = document.getElementById("filterStatus").value;
  gullyData.forEach(({ id, marker }) => {
    if (selected === 'All') {
      marker.addTo(map);
      return;
    }
    
    db.ref(`gullies/${id}/inspections`).orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
      const lastInspection = Object.values(snapshot.val() || {})[0];
      const status = lastInspection ? lastInspection.status : 'Unmarked';
      
      if (status === selected) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  });
}

function exportData() {
  if (currentRole !== 'admin') {
    alert('Only administrators can export data');
    return;
  }
  
  db.ref('gullies').once('value', snapshot => {
    const data = snapshot.val() || {};
    let csv = 'Gully ID,Latitude,Longitude,Last Inspection,Status,Inspector,Initials,Comment\n';
    
    Object.entries(data).forEach(([id, gully]) => {
      const inspections = Object.values(gully.inspections || {})
        .sort((a, b) => b.timestamp - a.timestamp);
      const last = inspections[0] || {};
      
      csv += `${id},${gully.location.lat},${gully.location.lng},${last.date || ''},${last.status || ''},${last.inspector || ''},${last.inspectorInitials || ''},"${(last.comment || '').replace(/"/g, '""')}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gully_inspections.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
}

function saveGullyData() {
  if (currentRole !== 'admin') {
    alert('Only administrators can backup data');
    return;
  }
  
  db.ref('gullies').once('value', snapshot => {
    const data = snapshot.val();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gully_data_backup.json';
    a.click();
    URL.revokeObjectURL(url);
  });
}

function resetMap() {
  if (currentRole !== 'admin' || !confirm('Are you sure you want to reset all data? This cannot be undone.')) {
    return;
  }
  
  db.ref('gullies').remove()
    .then(() => {
      gullyData.forEach(({ marker }) => map.removeLayer(marker));
      gullyData.length = 0;
      updateSummary();
    })
    .catch(error => alert('Error resetting data: ' + error.message));
}

function enableDeleteMode() {
  if (currentRole !== 'admin') {
    alert('Only administrators can delete gullies');
    return;
  }
  
  deleteMode = true;
  alert('Click any gully marker to delete it. This will remove all inspection data.');
}

function handleGullyDelete(id, marker, layerType = 'gullies') {
  if (!deleteMode || currentRole !== 'admin') return;
  
  if (confirm(`Delete this ${layerType} item and all its data?`)) {
    db.ref(`${layerType}/${id}`).remove()
      .then(() => {
        layers[layerType].removeLayer(marker);
        gullyData = gullyData.filter(g => g.id !== id);
        updateSummary();
        deleteMode = false;
      })
      .catch(error => alert(`Error deleting ${layerType} item: ` + error.message));
  }
}

function logout() {
  // Clear inactivity timer
  if (inactivityTimer) {
    clearTimeout(inactivityTimer);
    inactivityTimer = null;
  }
  
  // Remove event listeners
  document.removeEventListener('mousemove', resetInactivityTimer);
  document.removeEventListener('click', resetInactivityTimer);
  document.removeEventListener('keydown', resetInactivityTimer);
  document.removeEventListener('scroll', resetInactivityTimer);
  
  if (map) {
    map.off('drag', resetInactivityTimer);
    map.off('zoom', resetInactivityTimer);
    map.off('click', resetInactivityTimer);
  }
  
  document.removeEventListener('input', resetInactivityTimer);
  
  // Perform logout
  auth.signOut().then(() => location.reload());
}

function enableEditMode() {
  if (currentRole !== 'admin') {
    alert('Only administrators can edit gullies');
    return;
  }
  
  editMode = !editMode;
  deleteMode = false; // Disable delete mode when edit mode is enabled
  
  const editButton = document.querySelector('button[onclick="enableEditMode()"]');
  const deleteButton = document.querySelector('button[onclick="enableDeleteMode()"]');
  
  editButton.style.background = editMode ? '#ffeb3b' : '#f0f0f0';
  deleteButton.style.background = '#f0f0f0';
  
  map.getContainer().style.cursor = editMode ? 'pointer' : '';
  
  if (editMode) {
    alert('Edit mode enabled. Click any gully to edit its details.');
  }
}

async function updateGullyLocation(gullyId) {
  if (currentRole !== 'admin') {
    alert('Only administrators can update gully locations');
    return;
  }

  const lat = parseFloat(document.getElementById('lat').value);
  const lng = parseFloat(document.getElementById('lng').value);

  if (isNaN(lat) || isNaN(lng) || !isValidCoordinate(lng, lat)) {
    alert('Please enter valid coordinates');
    return;
  }

  try {
    // Update location in Firebase
    await db.ref(`gullies/${gullyId}/location`).set({ lat, lng });
    
    // Update marker position
    if (currentMarker) {
      currentMarker.setLatLng([lat, lng]);
    }
    
    alert('Gully location updated successfully');
    currentMarker.closePopup();
  } catch (error) {
    console.error('Error updating gully location:', error);
    alert('Error updating gully location: ' + error.message);
  }
}

function toggleLayerPanel() {
  const panel = document.getElementById('layerPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// Initialize the application
window.onload = () => {
  document.getElementById("loginScreen").style.display = "block";
};
</script>
</body>
</html>
