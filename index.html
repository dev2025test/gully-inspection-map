<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gully Inspection System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; display: none; }
    #loginScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3); text-align: center;
    }
    #controlPanel, #summary {
      position: absolute; background: white; padding: 10px;
      border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,0.3); z-index: 999;
    }
    #controlPanel { bottom: 10px; left: 10px; display: none; }
    #summary { top: 10px; right: 10px; font-size: 0.9em; display: none; }
    .dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #000; }
    .popup-form input, .popup-form select, .popup-form textarea { width: 100%; margin-bottom: 6px; }
    .inspection-popup .leaflet-popup-content {
      margin: 5px;
      width: auto !important;
    }
    .popup-form input[type="text"],
    .popup-form input[type="date"],
    .popup-form select,
    .popup-form textarea {
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .popup-form button {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .popup-form button:hover {
      background: #e0e0e0;
    }
    .popup-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div id="roleBanner" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);
background:#eee;padding:8px 20px;border-radius:6px;box-shadow:0 0 4px rgba(0,0,0,0.3);z-index:1001;
font-weight:bold;"></div>

<div id="loginScreen">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<div id="map"></div>

<div id="controlPanel">
  <label for="importFile" style="background:#ddd;padding:6px 12px;border-radius:4px;cursor:pointer;">üóÇÔ∏è Import</label>
  <input type="file" id="importFile" accept=".kml" style="display:none;">
  <span id="fileNameDisplay" style="margin-left:10px;font-style:italic;color:#555;"></span>
  
  <button onclick="exportData()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;margin-left:5px;">üíæ Export CSV</button>
  <button onclick="resetMap()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">‚ôªÔ∏è Reset</button>
  <button onclick="saveGullyData()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üíæ Backup JSON</button>
  <button onclick="enableDeleteMode()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;">üóëÔ∏è Delete Gully</button>
  <button onclick="logout()" style="padding:6px 12px;border-radius:4px;background:#f0f0f0;border:1px solid #ccc;margin-left:5px;">üö™ Logout</button>
</div>

<div id="summary">
  <b>Summary</b><br>
  <div id="summaryContent"></div>
  <label>Filter:</label>
  <select id="filterStatus" onchange="filterByStatus()">
    <option value="All">All</option>
    <option value="Clear">Clear</option>
    <option value="Broken">Broken</option>
    <option value="Remediation">Remediation</option>
    <option value="Replacement">Replacement</option>
    <option value="Blocked">Blocked</option>
    <option value="Expired">Expired</option>
  </select>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBsteq-tHQdiDcRk5UBg52AwAxpVcq67cw",
  authDomain: "gullytest3.firebaseapp.com",
  databaseURL: "https://gullytest3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gullytest3",
  storageBucket: "gullytest3.appspot.com",
  messagingSenderId: "876083677912",
  appId: "1:876083677912:web:065de0c7cca446b78f65ad"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let currentRole = null;
let map;
const importedFiles = new Set();
const gullyData = [];
let deleteMode = false;
let currentMarker = null;

function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  
  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      const uid = userCredential.user.uid;
      console.log('User logged in:', uid);
      
      // Check if user exists in users collection
      return db.ref("users/" + uid).once("value").then(snapshot => {
        if (!snapshot.exists()) {
          // If user doesn't exist, create them as admin (for first user)
          console.log('Creating new user with admin role');
          return db.ref("users/" + uid).set({
            email: email,
            role: 'admin',
            created: firebase.database.ServerValue.TIMESTAMP
          });
        } else {
          console.log('Existing user data:', snapshot.val());
          return snapshot;
        }
      });
    })
    .then(snapshot => {
      currentRole = snapshot.val().role || "admin";
      console.log('Current user role:', currentRole);
      document.getElementById("roleBanner").innerText = "Logged in as: " + currentRole.toUpperCase();
      
      // Setup UI based on role
      setupUIForRole(currentRole);
      
      // Initialize map and load data
      document.getElementById("loginScreen").style.display = 'none';
      document.getElementById("map").style.display = 'block';
      document.getElementById("controlPanel").style.display = 'block';
      document.getElementById("summary").style.display = 'block';

      initMap();
      loadGullyData();
    })
    .catch(error => {
      console.error('Login error:', error);
      document.getElementById("loginError").textContent = "‚ùå " + error.message;
    });
}

function setupUIForRole(role) {
  const isAdmin = role === 'admin';
  const isOperator = role === 'operator';
  
  document.getElementById("importFile").disabled = !isAdmin;
  document.querySelectorAll("#controlPanel button").forEach(btn => {
    if (btn.innerText.includes('Logout')) return;
    btn.disabled = !isAdmin;
    btn.style.opacity = btn.disabled ? 0.5 : 1;
  });
}

function initMap() {
  // Add custom CSS to ensure markers are always on top
  const customCSS = `
    .gully-marker {
      z-index: 1000 !important;
    }
    .dot {
      z-index: 1000 !important;
      opacity: 1 !important;
    }
    .leaflet-marker-icon {
      z-index: 1000 !important;
    }
    .leaflet-marker-pane {
      z-index: 600 !important;
    }
    .leaflet-popup-pane {
      z-index: 700 !important;
    }
  `;
  const style = document.createElement('style');
  style.textContent = customCSS;
  document.head.appendChild(style);

  map = L.map('map', {
    preferCanvas: false, // Use DOM elements for better z-index control
    zoomControl: true,
    maxZoom: 19
  }).setView([51.9, -8.5], 13);
  
  // Add tile layer with explicit z-index
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    zIndex: 100
  }).addTo(map);
  
  // Add scale control
  L.control.scale().addTo(map);
  
  document.getElementById('importFile').addEventListener('change', handleKMLImport);
}

function createDot(color) {
  return L.divIcon({
    className: 'gully-marker', // Added specific class for styling
    html: `<div class='dot' style='background:${color};width:20px;height:20px;border-radius:50%;border:3px solid black;box-shadow:0 0 4px white, 0 0 6px black;'></div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12]
  });
}

function addGullyToMap(latlng, gullyId) {
  console.log('Adding gully at:', latlng);
  
  const marker = new L.Marker([latlng.lat, latlng.lng], {
    icon: new L.DivIcon({
      className: 'custom-div-icon',
      html: "<div style='background-color:#808080;width:15px;height:15px;border-radius:50%;border:2px solid black'></div>",
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    })
  });
  
  marker.addTo(map);
  
  marker.on('click', () => {
    if (deleteMode) {
      handleGullyDelete(gullyId, marker);
    } else {
      currentMarker = marker; // Store the current marker
      showInspectionPopup(marker, gullyId, latlng);
    }
  });
  
  marker.setZIndexOffset(1000);
  
  gullyData.push({ marker, id: gullyId });
  return marker;
}

function handleKMLImport(event) {
  if (currentRole !== 'admin') {
    alert('Only administrators can import KML files');
    return;
  }

  const file = event.target.files[0];
  if (importedFiles.has(file.name)) {
    alert("This file has already been imported.");
    return;
  }
  
  importedFiles.add(file.name);
  const reader = new FileReader();
  
  reader.onload = async () => {
    try {
      console.log('File read successfully, parsing KML...');
      const kml = new DOMParser().parseFromString(reader.result, 'text/xml');
      const geojson = toGeoJSON.kml(kml);
      
      if (!geojson.features || geojson.features.length === 0) {
        alert('No valid points found in KML file');
        return;
      }

      console.log(`Found ${geojson.features.length} features in KML`);

      let pointsAdded = 0;
      let bounds = L.latLngBounds([]);
      let markers = [];
      
      // Clear any existing markers first
      gullyData.forEach(({ marker }) => {
        if (marker) {
          map.removeLayer(marker);
        }
      });
      gullyData.length = 0;
      
      // Process points
      for (const f of geojson.features) {
        if (f.geometry && f.geometry.type === 'Point' && f.geometry.coordinates) {
          const [lng, lat] = f.geometry.coordinates;
          
          if (isValidCoordinate(lng, lat)) {
            const gullyId = `gully_${Date.now()}_${pointsAdded}`;
            
            try {
              // Create marker first with grey color
              const marker = new L.Marker([lat, lng], {
                icon: new L.DivIcon({
                  className: 'custom-div-icon',
                  html: "<div style='background-color:#808080;width:15px;height:15px;border-radius:50%;border:2px solid black'></div>",
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                })
              });
              
              // Add it to the map
              marker.addTo(map);
              
              // Set up click handler
              marker.on('click', () => {
                if (deleteMode) {
                  handleGullyDelete(gullyId, marker);
                } else {
                  showInspectionPopup(marker, gullyId, { lat, lng });
                }
              });
              
              // Store in arrays
              markers.push(marker);
              gullyData.push({ marker, id: gullyId });
              bounds.extend([lat, lng]);
              pointsAdded++;
              
              // Save to Firebase with proper user reference
              await db.ref(`gullies/${gullyId}`).set({
                location: { lat, lng },
                created: firebase.database.ServerValue.TIMESTAMP,
                createdBy: auth.currentUser.uid,
                status: 'Unmarked'
              });
              
            } catch (err) {
              console.error('Error creating marker:', err);
            }
          }
        }
      }
      
      if (pointsAdded > 0) {
        // Fit bounds with padding
        const paddedBounds = bounds.pad(0.2);
        map.fitBounds(paddedBounds);
        
        // Force markers to front
        markers.forEach(marker => {
          if (marker) {
            marker.setZIndexOffset(1000);
          }
        });
        
        updateSummary();
        alert(`Successfully imported ${pointsAdded} gully points`);
      } else {
        alert('No valid gully points found in the KML file');
      }
    } catch (error) {
      console.error('Error in KML import:', error);
      alert('Error importing KML file: ' + error.message);
    }
  };
  
  reader.onerror = (error) => {
    console.error('Error reading file:', error);
    alert('Error reading file: ' + error.message);
  };
  
  reader.readAsText(file);
}

function isValidCoordinate(lng, lat) {
  return !isNaN(lng) && !isNaN(lat) && 
         lng >= -180 && lng <= 180 && 
         lat >= -90 && lat <= 90;
}

function showInspectionPopup(marker, gullyId, latlng) {
  console.log('Opening inspection popup for gully:', gullyId);
  currentMarker = marker; // Store current marker reference
  
  const popup = L.popup({
    maxWidth: 300,
    className: 'inspection-popup'
  });

  const formContent = `
    <div class="popup-form" style="padding: 10px;">
      <div style="margin-bottom: 10px;">
        <label>
          <input type="checkbox" id="complete" style="margin-right: 5px;">
          Inspection Complete
        </label>
      </div>
      
      <div style="margin-bottom: 10px;">
        <label>Date:</label><br>
        <input type="date" id="date" value="${new Date().toISOString().split('T')[0]}" style="width: 100%;">
      </div>
      
      <div style="margin-bottom: 10px;">
        <label>Status:</label><br>
        <select id="status" style="width: 100%;">
          <option value="Clear">Clear</option>
          <option value="Blocked">Blocked</option>
          <option value="Broken">Broken</option>
          <option value="Remediation">Remediation</option>
          <option value="Replacement">Replacement</option>
        </select>
      </div>
      
      <div style="margin-bottom: 10px;">
        <label>Comments:</label><br>
        <textarea id="comment" placeholder="Add inspection comments..." style="width: 100%; height: 60px;"></textarea>
      </div>
      
      <div style="margin-bottom: 10px;">
        <label>Photo:</label><br>
        <input type="file" id="photo" accept="image/*">
      </div>
      
      <div style="margin-top: 15px;">
        <button id="saveButton" style="margin-right: 10px;">üíæ Save</button>
        <button id="historyButton">üìã History</button>
      </div>
    </div>
  `;

  popup.setContent(formContent);
  marker.bindPopup(popup).openPopup();

  // Set up event handlers after popup is added to DOM
  setTimeout(() => {
    const canEdit = currentRole === 'admin' || currentRole === 'operator';
    const elements = document.querySelectorAll('.popup-form input, .popup-form select, .popup-form textarea');
    elements.forEach(el => {
      el.disabled = !canEdit;
    });
    
    // Set up save button handler
    const saveButton = document.getElementById('saveButton');
    if (saveButton) {
      saveButton.disabled = !canEdit;
      saveButton.addEventListener('click', () => {
        const formData = {
          complete: document.getElementById('complete').checked,
          date: document.getElementById('date').value,
          status: document.getElementById('status').value,
          comment: document.getElementById('comment').value,
          location: latlng
        };
        
        const photoFile = document.getElementById('photo').files[0];
        saveInspection(gullyId, formData, photoFile, marker);
      });
    }

    // Set up history button handler
    const historyButton = document.getElementById('historyButton');
    if (historyButton) {
      historyButton.addEventListener('click', () => viewGullyHistory(gullyId));
    }
  }, 100);
}

async function saveInspection(gullyId, data, photoFile, marker) {
  console.log('Starting inspection save for gully:', gullyId);
  console.log('Inspection data:', data);
  console.log('Current user role:', currentRole);
  console.log('Current user:', auth.currentUser?.uid);
  
  if (!data.complete) {
    alert('Please mark inspection as complete');
    return;
  }
  
  if (!auth.currentUser) {
    alert('You must be logged in to save inspections');
    return;
  }

  try {
    // Check if user has permission
    if (currentRole !== 'admin' && currentRole !== 'operator') {
      throw new Error('You do not have permission to save inspections');
    }

    // Verify user role in database
    const userRoleSnapshot = await db.ref(`users/${auth.currentUser.uid}/role`).once('value');
    const userRole = userRoleSnapshot.val();
    console.log('Verified user role from database:', userRole);

    if (userRole !== 'admin' && userRole !== 'operator') {
      throw new Error('Your role does not allow saving inspections');
    }

    // Create inspection data
    const inspectionData = {
      date: data.date,
      status: data.status,
      comment: data.comment,
      complete: data.complete,
      location: data.location,
      timestamp: firebase.database.ServerValue.TIMESTAMP,
      inspector: auth.currentUser.email,
      inspectorId: auth.currentUser.uid,
      inspectorRole: userRole
    };

    console.log('Prepared inspection data:', inspectionData);

    // Handle photo upload if present
    if (photoFile) {
      console.log('Uploading photo...');
      try {
        const photoRef = storage.ref(`photos/${gullyId}/${Date.now()}_${photoFile.name}`);
        await photoRef.put(photoFile);
        inspectionData.photoURL = await photoRef.getDownloadURL();
        console.log('Photo uploaded successfully:', inspectionData.photoURL);
      } catch (photoError) {
        console.error('Photo upload failed:', photoError);
      }
    }

    // Save to Firebase
    console.log('Saving to Firebase...');
    
    // Get a reference to the gully
    const gullyRef = db.ref(`gullies/${gullyId}`);
    
    // Create a new inspection entry
    const newInspectionRef = gullyRef.child('inspections').push();
    
    // Save inspection data
    await newInspectionRef.set(inspectionData);
    console.log('Inspection data saved successfully');

    // Update gully main record
    await gullyRef.update({
      lastInspection: inspectionData.timestamp,
      lastInspectionBy: auth.currentUser.email,
      status: data.status,
      updatedBy: auth.currentUser.uid,
      updatedByRole: userRole
    });
    console.log('Gully status updated');

    // Update marker appearance
    updateMarkerStatus(marker, data.status);
    marker.closePopup();
    
    // Update summary display
    updateSummary();
    
    alert('Inspection saved successfully');
    
  } catch (error) {
    console.error('Error in saveInspection:', error);
    alert(`Error saving inspection: ${error.message}\nPlease check console for details.`);
  }
}

function updateMarkerStatus(marker, status) {
  const color = getStatusColor(status);
  marker.setIcon(new L.DivIcon({
    className: 'custom-div-icon',
    html: `<div style='background-color:${color};width:15px;height:15px;border-radius:50%;border:2px solid black'></div>`,
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  }));
}

async function viewGullyHistory(gullyId) {
  try {
    const snapshot = await db.ref(`gullies/${gullyId}/inspections`).once('value');
    const inspections = snapshot.val() || {};
    
    const history = Object.values(inspections)
      .sort((a, b) => b.timestamp - a.timestamp)
      .map(i => `${new Date(i.timestamp).toLocaleDateString()}: ${i.status} - ${i.comment}`)
      .join('\n');
    
    alert(history || 'No inspection history');
  } catch (error) {
    alert('Error loading history: ' + error.message);
  }
}

function loadGullyData() {
  db.ref('gullies').on('value', snapshot => {
    const data = snapshot.val() || {};
    const existingIds = new Set(gullyData.map(g => g.id));
    
    Object.entries(data).forEach(([id, gully]) => {
      if (!existingIds.has(id)) {
        console.log('Loading gully from Firebase:', id);
        
        // Determine color based on status
        const status = gully.status || 'Unmarked';
        const color = getStatusColor(status);
        
        const marker = new L.Marker(gully.location, {
          icon: new L.DivIcon({
            className: 'custom-div-icon',
            html: `<div style='background-color:${color};width:15px;height:15px;border-radius:50%;border:2px solid black'></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(map);
        
        marker.setZIndexOffset(1000);
        
        marker.on('click', () => {
          if (deleteMode) {
            handleGullyDelete(id, marker);
          } else {
            showInspectionPopup(marker, id, gully.location);
          }
        });
        
        gullyData.push({ marker, id });
      }
    });
    
    updateSummary();
  });
}

function getStatusColor(status) {
  const colors = {
    Clear: '#0000FF', // Blue
    Blocked: '#FFA500', // Orange
    Broken: '#FF0000', // Red
    Remediation: '#800080', // Purple
    Replacement: '#FFFF00', // Yellow
    Expired: '#808080', // Gray
    Unmarked: '#808080' // Gray
  };
  return colors[status] || '#808080';
}

function updateSummary() {
  const counts = {
    Clear: 0,
    Blocked: 0,
    Broken: 0,
    Remediation: 0,
    Replacement: 0,
    Expired: 0,
    Unmarked: 0
  };
  
  gullyData.forEach(({ id }) => {
    db.ref(`gullies/${id}/inspections`).orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
      const lastInspection = Object.values(snapshot.val() || {})[0];
      if (!lastInspection) {
        counts.Unmarked++;
      } else {
        const ageMonths = (Date.now() - lastInspection.timestamp) / (1000 * 60 * 60 * 24 * 30.5);
        if (ageMonths > 12) {
          counts.Expired++;
        } else {
          counts[lastInspection.status]++;
        }
      }
      
      document.getElementById("summaryContent").innerHTML = `
        Total: ${gullyData.length}<br>
        <span style='color:blue;'>‚¨§</span> Clear: ${counts.Clear}<br>
        <span style='color:orange;'>‚¨§</span> Blocked: ${counts.Blocked}<br>
        <span style='color:red;'>‚¨§</span> Broken: ${counts.Broken}<br>
        <span style='color:purple;'>‚¨§</span> Remediation: ${counts.Remediation}<br>
        <span style='color:yellow;'>‚¨§</span> Replacement: ${counts.Replacement}<br>
        <span style='color:gray;'>‚¨§</span> Expired: ${counts.Expired}<br>
        <span style='color:lightgray;'>‚¨§</span> Unmarked: ${counts.Unmarked}
      `;
    });
  });
}

function filterByStatus() {
  const selected = document.getElementById("filterStatus").value;
  gullyData.forEach(({ id, marker }) => {
    if (selected === 'All') {
      marker.addTo(map);
      return;
    }
    
    db.ref(`gullies/${id}/inspections`).orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
      const lastInspection = Object.values(snapshot.val() || {})[0];
      const status = lastInspection ? lastInspection.status : 'Unmarked';
      
      if (status === selected) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  });
}

function exportData() {
  if (currentRole !== 'admin') {
    alert('Only administrators can export data');
    return;
  }
  
  db.ref('gullies').once('value', snapshot => {
    const data = snapshot.val() || {};
    let csv = 'Gully ID,Latitude,Longitude,Last Inspection,Status,Comment\n';
    
    Object.entries(data).forEach(([id, gully]) => {
      const inspections = Object.values(gully.inspections || {})
        .sort((a, b) => b.timestamp - a.timestamp);
      const last = inspections[0] || {};
      
      csv += `${id},${gully.location.lat},${gully.location.lng},${last.date || ''},${last.status || ''},"${(last.comment || '').replace(/"/g, '""')}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gully_inspections.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
}

function saveGullyData() {
  if (currentRole !== 'admin') {
    alert('Only administrators can backup data');
    return;
  }
  
  db.ref('gullies').once('value', snapshot => {
    const data = snapshot.val();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gully_data_backup.json';
    a.click();
    URL.revokeObjectURL(url);
  });
}

function resetMap() {
  if (currentRole !== 'admin' || !confirm('Are you sure you want to reset all data? This cannot be undone.')) {
    return;
  }
  
  db.ref('gullies').remove()
    .then(() => {
      gullyData.forEach(({ marker }) => map.removeLayer(marker));
      gullyData.length = 0;
      updateSummary();
    })
    .catch(error => alert('Error resetting data: ' + error.message));
}

function enableDeleteMode() {
  if (currentRole !== 'admin') {
    alert('Only administrators can delete gullies');
    return;
  }
  
  deleteMode = true;
  alert('Click any gully marker to delete it. This will remove all inspection data.');
}

function handleGullyDelete(gullyId, marker) {
  if (!deleteMode || currentRole !== 'admin') return;
  
  if (confirm('Delete this gully and all its inspection data?')) {
    db.ref(`gullies/${gullyId}`).remove()
      .then(() => {
        map.removeLayer(marker);
        gullyData = gullyData.filter(g => g.id !== gullyId);
        updateSummary();
        deleteMode = false;
      })
      .catch(error => alert('Error deleting gully: ' + error.message));
  }
}

function logout() {
  auth.signOut().then(() => location.reload());
}

// Initialize the application
window.onload = () => {
  document.getElementById("loginScreen").style.display = "block";
};
</script>
</body>
</html>
